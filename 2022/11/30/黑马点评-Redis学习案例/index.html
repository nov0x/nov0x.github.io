<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.17.2">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://fastly.jsdelivr.net'>
  <link rel="preconnect" href="https://fastly.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>黑马点评_Redis学习案例 - 7601</title>

  
    <meta name="description" content="导入项目 在虚拟机上安装redis并启动 idea中导入后端相关代码 MySQL中导入相关数据  启动后端项目，访问localhost:8081&#x2F;shop-type&#x2F;list。显示数据  启动nginx部署前端   只需要将nginx压缩包解压，进入文件夹用终端打开输入start nginx.exe即可启动nginx 启动nginx后访问localhost:8080检查是否运行">
<meta property="og:type" content="article">
<meta property="og:title" content="黑马点评_Redis学习案例">
<meta property="og:url" content="http://example.com/2022/11/30/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84-Redis%E5%AD%A6%E4%B9%A0%E6%A1%88%E4%BE%8B/index.html">
<meta property="og:site_name" content="7601">
<meta property="og:description" content="导入项目 在虚拟机上安装redis并启动 idea中导入后端相关代码 MySQL中导入相关数据  启动后端项目，访问localhost:8081&#x2F;shop-type&#x2F;list。显示数据  启动nginx部署前端   只需要将nginx压缩包解压，进入文件夹用终端打开输入start nginx.exe即可启动nginx 启动nginx后访问localhost:8080检查是否运行">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221014.10-03-39.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221014.10-03-59.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221015.11-34-46.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221015.11-35-31.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221016.19-27-00.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-15-59.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-14-21.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-39-24.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.15-02-31.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.16-17-32.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.16-06-30.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-13-02.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-18-08.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-05-50.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.13-51-55.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.14-12-45.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.16-10-32.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.08-42-45.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.09-08-17.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.09-42-00.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.10-20-36.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.15-56-22.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-10-45.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-18-13.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-23-13.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-36-51.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-52-00.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-54-31.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.17-06-38.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.15-53-49.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.15-58-54.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-08-51.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-10-39.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-26-59.png">
<meta property="og:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-32-05.png">
<meta property="article:published_time" content="2022-11-30T06:48:19.000Z">
<meta property="article:modified_time" content="2022-11-30T08:14:18.897Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221014.10-03-39.png">
<meta name="twitter:creator" content="@asdddfg">
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="title" href="/"><div class="main" ff="title">7601</div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/categories/">文章</a><a class="nav-item" href="/wiki/">项目</a><a class="nav-item" href="/more/">更多</a></nav>
</header>


<div class="widgets">

<widget class="widget-wrapper toc single" id="toc"><div class="widget-header cap dis-select"><span class="name">黑马点评_Redis学习案例</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">发送验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%B3%A8%E5%86%8C"><span class="toc-text">用户登录，以及注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">登录校验拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E4%BC%98%E5%8C%96"><span class="toc-text">返回数据优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4session%E7%9A%84%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-text">集群session的共享问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81-1"><span class="toc-text">发送验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-text">登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-text">登录状态刷新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0redis%E7%BC%93%E5%AD%98"><span class="toc-text">添加redis缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-text">解决方案：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0%EF%BC%9A"><span class="toc-text">概述：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A-1"><span class="toc-text">解决方案：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0%EF%BC%9A-1"><span class="toc-text">概述：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A-2"><span class="toc-text">解决方案：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">全局唯一ID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%8D%B7%E7%A7%92%E6%9D%80"><span class="toc-text">实现优惠卷秒杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B9%90%E8%A7%82%E9%94%81%E8%A7%A3%E5%86%B3%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-text">添加乐观锁解决并发安全问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-text">一人一单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">分布式锁的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%94%81"><span class="toc-text">获取锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E9%94%81"><span class="toc-text">释放锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%88%9D%E7%BA%A7%E7%89%88%E6%9C%AC"><span class="toc-text">基于redis实现分布式锁初级版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0"><span class="toc-text">解决分布式锁误删</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E8%84%9A%E6%9C%AC%E8%A7%A3%E5%86%B3%E5%91%BD%E4%BB%A4%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">Lua脚本解决命令原子性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E7%9A%84Lua%E8%84%9A%E6%9C%AC%EF%BC%9A"><span class="toc-text">编写的Lua脚本：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ELua%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E9%87%8A%E6%94%BE%E9%80%BB%E8%BE%91"><span class="toc-text">基于Lua脚本实现分布式锁的释放逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson"><span class="toc-text">Redisson</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%85%A5%E9%97%A8"><span class="toc-text">Redisson入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">Redisson可重入锁原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">Redisson分布式锁原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">Redisson分布式锁主从一致性问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EList%E7%BB%93%E6%9E%84%E6%A8%A1%E6%8B%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">基于List结构模拟消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EPubSub%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">基于PubSub的消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">基于Stream的消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Estream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-text">基于stream的消息队列-消费者组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%9A%84stream%E7%BB%93%E6%9E%84%E4%BD%9C%E4%B8%BA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">redis的stream结构作为消息队列，实现异步秒杀下单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E5%8F%91%E5%B8%83%E7%82%B9%E8%AF%84"><span class="toc-text">完善发布点评</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">完善点赞功能实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C"><span class="toc-text">点赞排行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">关注和取关接口实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">共同关注功能实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81"><span class="toc-text">关注推送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feed%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="toc-text">Feed流模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%8E%A8%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF%E5%8A%9F%E8%83%BD"><span class="toc-text">基于推模式实现关注推送消息功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">实现关注推送页面的分页查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">GEO数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E6%90%9C%E7%B4%A2"><span class="toc-text">附近商户搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BAGEO%E6%95%B0%E6%8D%AE"><span class="toc-text">导入店铺GEO数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9"><span class="toc-text">进行修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%B8%ADbitmap%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-text">redis中bitmap的用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">签到功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">签到统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9F%BA%E6%95%B0"><span class="toc-text">什么是基数?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-text">实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-HyperLogLog-%E5%91%BD%E4%BB%A4"><span class="toc-text">Redis HyperLogLog 命令</span></a></li></ol></div></div></widget>



<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/fri7601" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://avatars.githubusercontent.com/u/100124053?s=400&v=4"/></a></div></footer>

    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/notes/">notes</a></div><div id="post-meta">发布于&nbsp;<time datetime="2022-11-30T06:48:19.000Z">2022-11-30</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>黑马点评_Redis学习案例</span></h1>
<h1 id="导入项目"><a href="#导入项目" class="headerlink" title="导入项目"></a>导入项目</h1><ol>
<li>在虚拟机上安装redis并启动</li>
<li>idea中导入后端相关代码</li>
<li>MySQL中导入相关数据</li>
</ol>
<p>启动后端项目，访问localhost:8081&#x2F;shop-type&#x2F;list。显示数据</p>
<ol start="4">
<li>启动nginx部署前端</li>
</ol>
<ul>
<li>只需要将nginx压缩包解压，进入文件夹用终端打开输入start nginx.exe即可启动nginx</li>
<li>启动nginx后访问localhost:8080检查是否运行正常</li>
</ul>
<h1 id="基于session的短信登录"><a href="#基于session的短信登录" class="headerlink" title="基于session的短信登录"></a>基于session的短信登录</h1><h2 id="发送验证码"><a href="#发送验证码" class="headerlink" title="发送验证码"></a>发送验证码</h2><blockquote>
<p>由于其他部分已经完成，现在只需要创建对应的方法</p>
</blockquote>
<ul>
<li>userServiceImpl中创建方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCoed</span><span class="params">(String phone, HttpSession session)</span> &#123;  </span><br><span class="line">    <span class="comment">//使用正则表达式，校验手机号码是否正确  </span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号输入有误,请重新输入&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//使用工具类生成验证码  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);  </span><br><span class="line">    <span class="comment">//将验证码保存到session  </span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;code&quot;</span>,code);  </span><br><span class="line">    <span class="comment">//发送验证码，(模拟发送)  </span></span><br><span class="line">    log.debug(<span class="string">&quot;发送的验证码是===&quot;</span>+code);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="用户登录，以及注册"><a href="#用户登录，以及注册" class="headerlink" title="用户登录，以及注册"></a>用户登录，以及注册</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;  </span><br><span class="line">    <span class="comment">//再次校验手机号  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();  </span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone))&#123;  </span><br><span class="line">        <span class="keyword">return</span>  Result.fail(<span class="string">&quot;手机号有误&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//校验验证码  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span>(String) session.getAttribute(<span class="string">&quot;code&quot;</span>);  </span><br><span class="line">    <span class="comment">//这里先判断错误，可以避免在if中出现多层代码嵌套  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==session || !loginForm.getCode().equals(code))&#123;  </span><br><span class="line">       <span class="keyword">return</span>  Result.fail(<span class="string">&quot;验证码错误！！&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//根据手机号查询用户是否已注册过，未注册则进行注册  </span></span><br><span class="line">    <span class="comment">//query是mybatisPlus提供的  </span></span><br><span class="line">    <span class="type">User</span> <span class="variable">usr</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==usr)&#123;  </span><br><span class="line">       usr = createUsr(phone);  </span><br><span class="line">    &#125;  </span><br><span class="line">    session.setAttribute(<span class="string">&quot;user&quot;</span>,usr);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Result.ok();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 创建用户  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> phone  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">createUsr</span><span class="params">(String phone)</span> &#123;  </span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();  </span><br><span class="line">    user.setPhone(phone);  </span><br><span class="line">    user.setNickName(SystemConstants.USER_NICK_NAME_PREFIX +RandomUtil.randomString(<span class="number">5</span>));  </span><br><span class="line">    save(user);  </span><br><span class="line">    <span class="keyword">return</span> user;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="登录校验拦截器"><a href="#登录校验拦截器" class="headerlink" title="登录校验拦截器"></a>登录校验拦截器</h2><ul>
<li>对未登录的用户进行功能限制</li>
</ul>
<ol>
<li>创建拦截器：<br>创建类实现&#x3D;&#x3D;HandlerInterceptor&#x3D;&#x3D;方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//从session中查看用户是否存在  </span></span><br><span class="line">       <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> request.getSession().getAttribute(<span class="string">&quot;user&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span>==user)&#123;  </span><br><span class="line">            response.setStatus(<span class="number">2233</span>);  </span><br><span class="line">            <span class="keyword">return</span>  <span class="literal">false</span>;        &#125;  </span><br><span class="line">        <span class="comment">//若用户存在则保存到ThreadLocal，  </span></span><br><span class="line">        UserHolder.saveUser((UserDTO) user);  </span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">true</span>;    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建springMvc配置类实现&#x3D;&#x3D;WebMvcConfigurer&#x3D;&#x3D;或继承&#x3D;&#x3D;&#x3D;&#x3D;WebMvcConfigurationSupport&#x3D;&#x3D;，&#x3D;&#x3D;addInterceptors&#x3D;&#x3D;方法添加拦截器</li>
</ol>
<p>在spring中配置WebMvc时有两种方法，一种是继承WebMvcConfigurationSupport，<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E9%87%8D%E5%86%99&spm=1001.2101.3001.7020">重写</a>里面相应的方法，还有一种是继承WebMvcConfigurer的子抽象类WebMvcConfigurerAdapter，也是重写里面相应的方法，但是需要在配置类上添加@EnableWebMvc注解。那这两个类直接是什么关系呢？<br>WebMvcConfigurationSupport中那些子类可以重写的空方法在<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=WebMvcConfigurer&spm=1001.2101.3001.7020">WebMvcConfigurer</a>都有，这说明WebMvcConfigurer只是WebMvcConfigurationSupport的一个扩展类，它并没有扩展新功能，只是为让用户更方便安全的添加自定义配置，为什么说是安全呢？因为如果直接继承WebMvcConfigurationSupport，那么用户可以重写默认的配置，如果对原理不是很清楚地开发者不小心重写了默认的配置，springmvc可能相关功能就无法生效，是一种不安全的行为。但如果是继承WebMvcConfigurerAdapter，那么开发者是在默认配置的基础上添加自定义配置，相对来说更安全一些，只不过要多加一个@EnableWebMvc注解。从这个角度来说，最佳实践还是继承WebMvcConfigurerAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;  </span><br><span class="line">        registry.addInterceptor(loginInterceptor).excludePathPatterns(  </span><br><span class="line">                               <span class="comment">//需要放行的请求  </span></span><br><span class="line">               <span class="string">&quot;/shop/**&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/voucher/**&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/shop-type/**&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/upload/**&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/blog/hot&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/user/code&quot;</span>,  </span><br><span class="line">               <span class="string">&quot;/user/login&quot;</span>  </span><br><span class="line">        );  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="返回数据优化"><a href="#返回数据优化" class="headerlink" title="返回数据优化"></a>返回数据优化</h2><ul>
<li>原先session保存的用户数据中包含了密码手机号等，隐私信息不安全，同时多占用了内存</li>
<li>改为使用userDTO，返回需要的数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> Long id;  </span><br><span class="line">    <span class="keyword">private</span> String nickName;  </span><br><span class="line">    <span class="keyword">private</span> String icon;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>BeanUtil.copyProperties()，是hutool提供一个拷贝数据的方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();  </span><br><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>,  </span><br><span class="line">BeanUtil.copyProperties(usr,UserDTO.class,<span class="string">&quot;password&quot;</span>,<span class="string">&quot;phone&quot;</span>,<span class="string">&quot;create_time&quot;</span>,<span class="string">&quot;update_time&quot;</span>));  </span><br><span class="line"><span class="keyword">return</span> Result.ok();</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="token验证"><a href="#token验证" class="headerlink" title="token验证"></a>token验证</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a32634a5170c">Token登录认证 - 简书 (jianshu.com)</a></p>
<h1 id="基于redis的短信登录"><a href="#基于redis的短信登录" class="headerlink" title="基于redis的短信登录"></a>基于redis的短信登录</h1><h2 id="集群session的共享问题"><a href="#集群session的共享问题" class="headerlink" title="集群session的共享问题"></a>集群session的共享问题</h2><ul>
<li>多台tomcat并不共享session储存空间，当切换到不同服务器是会造成数据丢失</li>
<li>存储数据时使用手机号码作为key，保证数据的唯一性，之前储存在session中统一使用字符串“code”作为key是因为每个浏览器携带的session都是不同的，现在使用redis作为统一的存储空间，需要保证唯一性</li>
</ul>
<h2 id="发送验证码-1"><a href="#发送验证码-1" class="headerlink" title="发送验证码"></a>发送验证码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sendCoed</span><span class="params">(String phone, HttpSession session)</span> &#123;  </span><br><span class="line">        <span class="comment">//使用正则表达式，校验手机号码是否正确  </span></span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;手机号输入有误,请重新输入&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//使用工具类生成验证码  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);  </span><br><span class="line">        <span class="comment">//将验证码保存到session  </span></span><br><span class="line"><span class="comment">//        session.setAttribute(&quot;code&quot;,code);  </span></span><br><span class="line">        <span class="comment">//将验证码改为保存到redis中  手机号码作为key，并设置为1分钟的过期时间  </span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(LoginConstants.LOGIN_CODE+phone,code,LoginConstants.CODE_TTL, TimeUnit.MINUTES);  </span><br><span class="line">        <span class="comment">//发送验证码，(模拟发送)  </span></span><br><span class="line">        log.debug(<span class="string">&quot;发送的验证码是===&quot;</span>+code);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok();  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;  </span><br><span class="line">        <span class="comment">//再次校验手机号  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();  </span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone))&#123;  </span><br><span class="line">            <span class="keyword">return</span>  Result.fail(<span class="string">&quot;手机号有误&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line"><span class="comment">//        //校验验证码  </span></span><br><span class="line"><span class="comment">//        String code =(String) session.getAttribute(&quot;code&quot;);  </span></span><br><span class="line">        <span class="comment">//改为从redis获取保存的验证码  </span></span><br><span class="line">        <span class="type">String</span>  <span class="variable">code</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(LoginConstants.LOGIN_CODE + phone);  </span><br><span class="line">        <span class="comment">//这里先判断错误，可以避免在if中出现多层代码嵌套  </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span>==session || !loginForm.getCode().equals(code))&#123;  </span><br><span class="line">           <span class="keyword">return</span>  Result.fail(<span class="string">&quot;验证码错误！！&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//根据手机号查询用户是否已注册过，未注册则进行注册  </span></span><br><span class="line">        <span class="comment">//query是mybatisPlus提供的  </span></span><br><span class="line">        <span class="type">User</span> <span class="variable">usr</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span>==usr)&#123;  </span><br><span class="line">           usr = createUsr(phone);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//生成随机的token(这里简单的使用uuid随机生成)保存，并返回给客户端  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);  </span><br><span class="line"><span class="comment">//        session.setAttribute(&quot;user&quot;,  </span></span><br><span class="line"><span class="comment">//                BeanUtil.copyProperties(usr,UserDTO.class,&quot;password&quot;,&quot;phone&quot;,&quot;create_time&quot;,&quot;update_time&quot;));  </span></span><br><span class="line">        <span class="comment">//将用户信息改为储存到redis中  </span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(usr, UserDTO.class, <span class="string">&quot;password&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;phone&quot;</span>, <span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;update_time&quot;</span>);  </span><br><span class="line">        <span class="comment">//保存到LocalThead中  </span></span><br><span class="line">        UserHolder.saveUser(userDTO);  </span><br><span class="line">        <span class="comment">//由于在通过hashMap储存到redis时，StringRedisTemplate只允许储存string类型的字段  </span></span><br><span class="line">        <span class="comment">//UserDTO的id字段为Long类型会出现错误，可以将数据取出手动进行处理，  </span></span><br><span class="line">        <span class="comment">// 也可以在 BeanUtil.beanToMap()方法转换时通过CopyOptions.create()，进行相应设置  </span></span><br><span class="line">        <span class="comment">//setIgnoreNullValue(true)，是否忽略值为空的字段  </span></span><br><span class="line">        <span class="comment">//setFieldValueEditor(),可以对字段的值进行修改，这里将值修改为字符串类型  </span></span><br><span class="line">        Map&lt;String, Object&gt; objectMap =  </span><br><span class="line">                BeanUtil.beanToMap(  </span><br><span class="line">                        userDTO,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),  </span><br><span class="line">                        CopyOptions.create().setIgnoreNullValue(<span class="literal">true</span>).  </span><br><span class="line">                                setFieldValueEditor((fieldName,fieldValue)-&gt;fieldValue.toString())  </span><br><span class="line">                );  </span><br><span class="line">  </span><br><span class="line">        stringRedisTemplate.opsForHash().putAll(LoginConstants.LOGIN_TOKEN+token,objectMap);  </span><br><span class="line">        <span class="comment">//设置token过期时间  </span></span><br><span class="line">        stringRedisTemplate.expire(LoginConstants.LOGIN_TOKEN+token,LoginConstants.TOKEN_TTL,TimeUnit.MINUTES);  </span><br><span class="line">        <span class="comment">//返回token  </span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(token);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="comment">//若没有@Component注解，则该类不会被spring管理不能自动装配StringRedisTemplate，  </span></span><br><span class="line">    <span class="comment">// 只能使用构造函数来创建StringRedisTemplate  </span></span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//从session中查看用户是否存在  </span></span><br><span class="line">  <span class="comment">//     Object user = request.getSession().getAttribute(&quot;user&quot;);  </span></span><br><span class="line">        <span class="comment">//获取token验证 ,根据前端将token保存在定义的authorization header中获取  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(token))&#123;  </span><br><span class="line">            response.setStatus(<span class="number">2233</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;        &#125;  </span><br><span class="line">        <span class="comment">//根据token取出数据  </span></span><br><span class="line">        Map&lt;Object, Object&gt; entries = stringRedisTemplate.opsForHash().entries(  </span><br><span class="line">                LoginConstants.LOGIN_TOKEN+token);  </span><br><span class="line">        <span class="keyword">if</span> (entries.isEmpty())&#123;  </span><br><span class="line">            response.setStatus(<span class="number">2233</span>);  </span><br><span class="line">            <span class="keyword">return</span>  <span class="literal">false</span>;        &#125;  </span><br><span class="line">        <span class="comment">//将map转换为UserDTO  </span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(entries,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);  </span><br><span class="line">        <span class="comment">//若用户存在则保存到ThreadLocal，  </span></span><br><span class="line">        UserHolder.saveUser((UserDTO) user);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//刷新token有效期  </span></span><br><span class="line">        stringRedisTemplate.expire(LoginConstants.LOGIN_TOKEN+token,LoginConstants.TOKEN_TTL, TimeUnit.MINUTES);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">true</span>;    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据前端信息，token被保存在自定义的头authorization中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);  </span><br></pre></td></tr></table></figure>


<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221014.10-03-39.png" alt="image-20221014100338022"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221014.10-03-59.png" alt="image-20221014100358533"></p>
<h2 id="登录状态刷新"><a href="#登录状态刷新" class="headerlink" title="登录状态刷新"></a>登录状态刷新</h2><ul>
<li><p>最开始为了在用户一直操作时保持一直登录不退出，在拦截器上进行了过期时间刷新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//刷新token有效期  </span></span><br><span class="line">stringRedisTemplate.expire(LoginConstants.LOGIN_TOKEN+token,LoginConstants.TOKEN_TTL, TimeUnit.MINUTES);  </span><br></pre></td></tr></table></figure>
</li>
<li><p>但是这样操作，会导致其他未被拦截的请求。无法触发刷新过期时间，使数据过期，</p>
</li>
<li><p>有可能导致当用户明明一直在进行操作，却还需要再次登录</p>
</li>
</ul>
<p><strong>解决方法</strong>：</p>
<ul>
<li><p>再添加一个拦截所有请求的拦截器，</p>
</li>
<li><p>由该拦截器进行获取token并刷新，redis查询用户，以及保存数据到TheadLocal</p>
</li>
<li><p>原来的登录校验拦截器则只进行查询TheadLocal判断有无数据：有放行，无则拦截</p>
</li>
<li><p>新的拦截所有请求的拦截器</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="comment">//若没有@Component注解，则该类不会被spring管理不能自动装配StringRedisTemplate，  </span></span><br><span class="line">    <span class="comment">// 只能使用构造函数来创建StringRedisTemplate  </span></span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//从session中查看用户是否存在  </span></span><br><span class="line">  <span class="comment">//     Object user = request.getSession().getAttribute(&quot;user&quot;);  </span></span><br><span class="line">        <span class="comment">//获取token验证 ,根据前端将token保存在定义的authorization header中获取  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(token))&#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//根据token取出数据  </span></span><br><span class="line">        Map&lt;Object, Object&gt; entries = stringRedisTemplate.opsForHash().entries(  </span><br><span class="line">                LoginConstants.LOGIN_TOKEN+token);  </span><br><span class="line">        <span class="keyword">if</span> (entries.isEmpty())&#123;  </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;     &#125;  </span><br><span class="line">        <span class="comment">//将map转换为UserDTO  </span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(entries,<span class="keyword">new</span> <span class="title class_">UserDTO</span>(),<span class="literal">false</span>);  </span><br><span class="line">        <span class="comment">//若用户存在则保存到ThreadLocal，  </span></span><br><span class="line">        UserHolder.saveUser((UserDTO) user);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//刷新token有效期  </span></span><br><span class="line">        stringRedisTemplate.expire(LoginConstants.LOGIN_TOKEN+token,LoginConstants.TOKEN_TTL, TimeUnit.MINUTES);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">true</span>;    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li><p>现在的登录拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == user) &#123;  </span><br><span class="line">            response.setStatus(<span class="number">2233</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>在添加拦截器时还可以设置拦截器的拦截顺序，默认是先添加的先执行，也可以通过&#x3D;&#x3D;.order()&#x3D;&#x3D;方法设置值，值越小越先执行</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> GlobalInterceptor globalInterceptor;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;  </span><br><span class="line">        registry.addInterceptor(loginInterceptor).excludePathPatterns(  </span><br><span class="line">                               <span class="comment">//需要放行的请求  </span></span><br><span class="line">                <span class="string">&quot;/shop/**&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/voucher/**&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/shop-type/**&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/upload/**&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/blog/hot&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/user/code&quot;</span>,  </span><br><span class="line">                <span class="string">&quot;/user/login&quot;</span>  </span><br><span class="line">        ).order(<span class="number">1</span>);  </span><br><span class="line">        registry.addInterceptor(globalInterceptor).excludePathPatterns().order(<span class="number">0</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="商户查询缓存"><a href="#商户查询缓存" class="headerlink" title="商户查询缓存"></a>商户查询缓存</h1><p><strong>缓存</strong>数据交换的缓冲区，是储存存储数据的临时地方，读写性能较高</p>
<ul>
<li>降低后端负载</li>
<li>提高读写效率，降低响应时间</li>
</ul>
<h2 id="添加redis缓存"><a href="#添加redis缓存" class="headerlink" title="添加redis缓存"></a>添加redis缓存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span>  <span class="variable">info</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);  </span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(info))&#123;  </span><br><span class="line">        <span class="comment">//存在缓存，则将json字符串转换为bean并返回数据  </span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(info, Shop.class);  </span><br><span class="line">        <span class="keyword">return</span>  Result.ok(shop);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.getById(id);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==shop)&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;数据不存在！！&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//数据存在则写入redis  </span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.CACHE_SHOP_KEY+id,JSONUtil.toJsonStr(shop));  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="缓存更新策略"><a href="#缓存更新策略" class="headerlink" title="缓存更新策略"></a>缓存更新策略</h1><table>
<thead>
<tr>
<th></th>
<th>内存淘汰</th>
<th>超时剔除</th>
<th>主动更新</th>
</tr>
</thead>
<tbody><tr>
<td>说明</td>
<td>不用自己维护，利用redis的内存淘汰机制，当内存不足时自动淘汰部分数据下次查询时更新缓存</td>
<td>给缓存数据添加ttl时间到期后自动删除缓存，下次查询时更新缓存</td>
<td>编写业务逻辑，在修改数据库的同时,更新缓存</td>
</tr>
<tr>
<td>一致性</td>
<td>差</td>
<td>一般</td>
<td>好</td>
</tr>
<tr>
<td>维护成本</td>
<td>无</td>
<td>低</td>
<td>高</td>
</tr>
</tbody></table>
<ul>
<li>在低一致性需求时，可以使用redis自带的内存淘汰机制</li>
<li>在高一致性需求时，主动更新，并同时设置超时时间以免出现错误</li>
</ul>
<p><strong>读操作</strong>：</p>
<ul>
<li>查询到缓存直接返回</li>
<li>未查询到到缓存，则查询数据库，并写入缓存，设置超时时间</li>
</ul>
<p><strong>写操作</strong>：</p>
<ul>
<li>先写数据库，然后再删除缓存</li>
<li>确保数据库与缓存操作的原子性<a href="%E6%8C%87%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%B8%8D%E5%8F%AF%E5%88%86%E5%89%B2%E6%80%A7%EF%BC%8C%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%89%80%E6%9C%89%E6%93%8D%E4%BD%9C%E8%A6%81%E4%B9%88%E4%B8%8D%E9%97%B4%E6%96%AD%E5%9C%B0%E5%85%A8%E9%83%A8%E8%A2%AB%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%A6%81%E4%B9%88%E4%B8%80%E4%B8%AA%E4%B9%9F%E6%B2%A1%E6%9C%89%E6%89%A7%E8%A1%8C%E3%80%82">^atomicity</a></li>
</ul>
<h1 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h1><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li>我们使用Redis大部分情况都是通过Key查询对应的值，假如发送的请求传进来的key是不存在Redis中的，那么就查不到缓存，查不到缓存就会去数据库查询。假如有大量这样的请求，这些请求像“穿透”了缓存一样直接打在数据库上，这种现象就叫做缓存穿透。</li>
</ul>
<p><strong>分析：</strong></p>
<p>关键在于在Redis查不到key值，这和缓存击穿有根本的区别，区别在于<strong>缓存穿透的情况是传进来的key在Redis中是不存在的</strong>。假如有黑客传进大量的不存在的key，那么大量的请求打在数据库上是很致命的问题，所以在日常开发中要对参数做好校验，一些非法的参数，不可能存在的key就直接返回错误提示，要对调用方保持这种“不信任”的心态。</p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><p>1、<strong>把无效的Key存进Redis中（缓存空对象）</strong>。如果Redis查不到数据，数据库也查不到，我们把这个Key值保存进Redis，设置value&#x3D;”null”，当下次再通过这个Key查询时就不需要再查询数据库。这种处理方式肯定是有问题的，假如传进来的这个不存在的Key值每次都是随机的，那存进Redis也没有意义。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221015.11-34-46.png" alt="image-20221015113445258"></p>
<p>2、<strong>使用布隆过滤器</strong>。布隆过滤器的作用是某个 key 不存在，那么就一定不存在，它说某个 key 存在，那么很大可能是存在(存在一定的误判率)。于是我们可以在缓存之前再加一层布隆过滤器，在查询的时候先去布隆过滤器查询 key 是否存在，如果不存在就直接返回。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221015.11-35-31.png" alt="image-20221015113530360"></p>
<h1 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h1><h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p><strong>什么是缓存雪崩？</strong></p>
<ul>
<li>当某一个时刻出现大规模的缓存失效的情况，那么就会导致大量的请求直接打在数据库上面，导致数据库压力巨大，如果在高并发的情况下，可能瞬间就会导致数据库宕机。这时候如果运维马上又重启数据库，马上又会有新的流量把数据库打死。这就是缓存雪崩。</li>
</ul>
<p><strong>分析：</strong></p>
<p>造成缓存雪崩的关键在于在同一时间大规模的key失效。为什么会出现这个问题呢，有几种可能，第一种可能是Redis宕机，第二种可能是采用了相同的过期时间。搞清楚原因之后，那么有什么解决方案呢？</p>
<h3 id="解决方案：-1"><a href="#解决方案：-1" class="headerlink" title="解决方案："></a>解决方案：</h3><p>1、在原有的失效时间上加上一个随机值，比如1-5分钟随机。这样就避免了因为采用相同的过期时间导致的缓存雪崩。</p>
<p>如果真的发生了缓存雪崩，有没有什么兜底的措施？</p>
<p>2、使用熔断机制。当流量到达一定的阈值时，就直接返回“系统拥挤”之类的提示，防止过多的请求打在数据库上。至少能保证一部分用户是可以正常使用，其他用户多刷新几次也能得到结果。(业务降级限流)</p>
<p>3、提高数据库的容灾能力，可以使用分库分表，读写分离的策略。</p>
<p>4、为了防止Redis宕机导致缓存雪崩的问题，可以搭建Redis集群，提高Redis的容灾性。</p>
<h1 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h1><h2 id="概述：-1"><a href="#概述：-1" class="headerlink" title="概述："></a>概述：</h2><p><strong>什么是缓存击穿？</strong></p>
<p>其实跟缓存雪崩有点类似，缓存雪崩是大规模的key失效，而缓存击穿是一个热点的Key，有大并发集中缓存重建业务较复杂对其进行访问，突然间这个Key失效了，导致大并发全部打在数据库上，导致数据库压力剧增。这种现象就叫做缓存击穿。</p>
<p><strong>分析：</strong></p>
<p>关键在于某个热点的key失效了，导致大并发集中打在数据库上。所以要从两个方面解决，第一是否可以考虑热点key不设置过期时间，第二是否可以考虑降低打在数据库上的请求数量。</p>
<h2 id="解决方案：-2"><a href="#解决方案：-2" class="headerlink" title="解决方案："></a>解决方案：</h2><p>1、<strong>逻辑过期</strong>如果业务允许的话，对于热点的key可以设置永不过期的key。</p>
<ul>
<li>线程无需等待，性能较好</li>
<li>不保证唯一性</li>
<li>有额外的内存消耗</li>
<li>实现复杂</li>
</ul>
<p>2、使用<strong>互斥锁</strong>。如果缓存失效的情况，只有拿到锁才可以查询数据库，降低了在同一时刻打在数据库上的请求，防止数据库打死。当然这样会导致系统的性能变差。</p>
<ul>
<li>（没有额外的内存消耗，保证一致性，实现简单）</li>
<li>线程需要等待，性能受影响</li>
<li>可能出现死锁风险</li>
</ul>
<h1 id="基于互斥锁解决缓存击穿"><a href="#基于互斥锁解决缓存击穿" class="headerlink" title="基于互斥锁解决缓存击穿"></a>基于互斥锁解决缓存击穿</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Shop <span class="title function_">query_CacheBreakdown</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);  </span><br><span class="line">    <span class="comment">//isNotBlank，null,空字符串，转义字符都返回false  </span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(info)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(info, Shop.class);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//判断是否未空值  </span></span><br><span class="line">    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//1实现缓存重建  </span></span><br><span class="line">    <span class="comment">//1.1获取互斥锁  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;  </span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">is_get</span> <span class="operator">=</span> getLockKey(lockKey);  </span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">//1.2判断是否成功获取  </span></span><br><span class="line">        <span class="keyword">if</span> (!is_get) &#123;  </span><br><span class="line">            <span class="comment">//1.3 获取失败，休眠并重试  </span></span><br><span class="line">            Thread.sleep(<span class="number">50</span>);  </span><br><span class="line">            <span class="keyword">return</span> query_CachePassThrough(id);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//获取锁成功后再次检查缓存是否存在  </span></span><br><span class="line">        info = stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);  </span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(info)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(info, Shop.class);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//1.4 获取成功，根据id查询数据库  </span></span><br><span class="line">        shop = getById(id);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//模拟构建延时  </span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == shop) &#123;  </span><br><span class="line">            <span class="comment">//将空值写入缓存  </span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(RedisConstants.CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;        &#125;  </span><br><span class="line">        <span class="comment">//数据存在则写入redis  </span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(RedisConstants.CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop),  </span><br><span class="line">                RedisConstants.CACHE_SHOP_TTL, TimeUnit.MINUTES);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">        <span class="comment">//1.5 释放互斥锁  </span></span><br><span class="line">        unLockKey(lockKey);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> shop;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用apifox进行高并发测试</li>
</ul>
<h1 id="基于逻辑过期解决缓存击穿"><a href="#基于逻辑过期解决缓存击穿" class="headerlink" title="基于逻辑过期解决缓存击穿"></a>基于逻辑过期解决缓存击穿</h1><ul>
<li>需要提前添加要设置的热点数据</li>
</ul>
<p>提前添加的热点数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span>  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">   <span class="keyword">private</span> ShopServiceImpl shopService;  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testShop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        shopService.testSaveShop(<span class="number">1L</span>,<span class="number">10L</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建线程池  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR_SERVICE</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> Shop <span class="title function_">query_LogicalExpiration</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);  </span><br><span class="line">    <span class="comment">//isNotBlank，null,空字符串，转义字符都返回false  </span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(info)) &#123;  </span><br><span class="line">        <span class="comment">//不存在缓存，直接返回空  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//存在，反序列化为对象，判断是否过期  </span></span><br><span class="line">    <span class="comment">//将redisData对象中的data取出并不能直接转为Shop对象，  </span></span><br><span class="line">    <span class="comment">//因为再data的属性为Object，需要先转换为JsonObject再转换为Shop对象  </span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(info, RedisData.class);  </span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> (JSONObject) redisData.getData();  </span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(jsonObject, Shop.class);  </span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;  </span><br><span class="line">        <span class="comment">//未过期，直接返回对象  </span></span><br><span class="line">        <span class="keyword">return</span> shop;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//  过期进行缓存重建  </span></span><br><span class="line">    <span class="comment">//缓存重建,1.获取互斥锁  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;  </span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> getLockKey(lockKey);  </span><br><span class="line">    <span class="comment">//2.判断是否获取锁成功  </span></span><br><span class="line">    <span class="keyword">if</span> (isLock) &#123;  </span><br><span class="line">        <span class="comment">//3.成功：开启独立线程，实现缓存重建  </span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR_SERVICE.submit(() -&gt; &#123;  </span><br><span class="line">            <span class="comment">//重建缓存  </span></span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="built_in">this</span>.testSaveShop(id, <span class="number">20L</span>);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                <span class="comment">//释放锁  </span></span><br><span class="line">                unLockKey(lockKey);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//获取锁成功后再次检查缓存是否存在  </span></span><br><span class="line">    info = stringRedisTemplate.opsForValue().get(RedisConstants.CACHE_SHOP_KEY + id);  </span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(info)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(info, Shop.class);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//返回过期商铺信息  </span></span><br><span class="line">    <span class="keyword">return</span> shop;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveShop</span><span class="params">(Long id, Long expireSeconds)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">    <span class="comment">//查询店铺数据  </span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);  </span><br><span class="line">    <span class="comment">//模拟延迟  </span></span><br><span class="line">    Thread.sleep(<span class="number">200</span>);  </span><br><span class="line">    <span class="comment">//封装逻辑过期时间  </span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();  </span><br><span class="line">    redisData.setData(shop);  </span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));  </span><br><span class="line">    <span class="comment">//写入redis  </span></span><br><span class="line">    stringRedisTemplate.opsForValue().  </span><br><span class="line">            set(RedisConstants.CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试</p>
<h1 id="缓存工具封装"><a href="#缓存工具封装" class="headerlink" title="缓存工具封装"></a>缓存工具封装</h1><ul>
<li>工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.BooleanUtil;  </span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;  </span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;  </span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.Shop;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;  </span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClientUtil</span> &#123;  </span><br><span class="line">    <span class="comment">//创建线程池  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR_SERVICE</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//这里使用的是构造函数注入StringRedisTemplate  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClientUtil</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;  </span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * 保存并设置逻辑过期时间  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeUnit  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogicalExpire</span><span class="params">(String key,Object value,Long time,TimeUnit timeUnit)</span>&#123;  </span><br><span class="line">              <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();  </span><br><span class="line">              redisData.setData(value);  </span><br><span class="line">              redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));  </span><br><span class="line">  </span><br><span class="line">              stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> &lt;R,ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type,  </span></span><br><span class="line"><span class="params">                                         Function&lt;ID,R&gt; function,Long time,TimeUnit timeUnit)</span>&#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix+id;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);  </span><br><span class="line">        <span class="comment">//isNotBlank，null,空字符串，转义字符都返回false  </span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(info)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(info, type);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//判断是否未空值  </span></span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//由于不知道要查询的是那个类型的数据，  </span></span><br><span class="line">        <span class="comment">//所以由调用者传入对应的查询函数 Function&lt;ID,R&gt; 需要的函数参数为ID,返回值为R  </span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> function.apply(id);  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == r) &#123;  </span><br><span class="line">            <span class="comment">//将空值写入缓存  </span></span><br><span class="line">            stringRedisTemplate.opsForValue().set( key, <span class="string">&quot;&quot;</span>,  time, timeUnit);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;        &#125;  </span><br><span class="line">        <span class="comment">//数据存在则写入redis  </span></span><br><span class="line">         <span class="built_in">this</span>.set(key,r,time,timeUnit);  </span><br><span class="line">        <span class="keyword">return</span> r;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span>  &lt;R,ID&gt; R <span class="title function_">query_LogicalExpiration</span><span class="params">(String keyPrefix,ID id,Class&lt;R&gt; type,  </span></span><br><span class="line"><span class="params">                                             Function&lt;ID,R&gt; function,Long time,TimeUnit timeUnit)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix+id;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);  </span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(info)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//存在，反序列化为对象，判断是否过期  </span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(info, RedisData.class);  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> (JSONObject) redisData.getData();  </span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean(jsonObject,type);  </span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;  </span><br><span class="line">            <span class="comment">//未过期，直接返回对象  </span></span><br><span class="line">            <span class="keyword">return</span> r;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//  过期进行缓存重建  </span></span><br><span class="line">        <span class="comment">//缓存重建,1.获取互斥锁  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisConstants.LOCK_SHOP_KEY + id;  </span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> getLockKey(lockKey);  </span><br><span class="line">        <span class="comment">//2.判断是否获取锁成功  </span></span><br><span class="line">        <span class="keyword">if</span> (isLock) &#123;  </span><br><span class="line">            <span class="comment">//3.成功：开启独立线程，实现缓存重建  </span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR_SERVICE.submit(() -&gt; &#123;  </span><br><span class="line">                <span class="comment">//重建缓存  </span></span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                   <span class="comment">//查询数据库  </span></span><br><span class="line">                    <span class="type">R</span> <span class="variable">apply</span> <span class="operator">=</span> function.apply(id);  </span><br><span class="line">                    <span class="comment">//写入redis  </span></span><br><span class="line">                  <span class="built_in">this</span>.setLogicalExpire(key,apply,time,timeUnit);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                    <span class="comment">//释放锁  </span></span><br><span class="line">                    unLockKey(lockKey);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//获取锁成功后再次检查缓存是否存在  </span></span><br><span class="line">        info = stringRedisTemplate.opsForValue().get(key);  </span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(info)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(info, type);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//返回过期商铺信息  </span></span><br><span class="line">        <span class="keyword">return</span> r;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * 生成锁  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">private</span> Boolean <span class="title function_">getLockKey</span><span class="params">(String key)</span> &#123;  </span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">aBoolean</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>,  </span><br><span class="line">                <span class="number">10</span>, TimeUnit.SECONDS);  </span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(aBoolean);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * 删除锁  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unLockKey</span><span class="params">(String key)</span> &#123;  </span><br><span class="line">        stringRedisTemplate.delete(key);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>工具类方法的调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> CacheClientUtil cacheClientUtil;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">query</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">        <span class="comment">//使用工具类解决缓存穿透  </span></span><br><span class="line"><span class="comment">//     Shop shop =  cacheClientUtil.queryWithPassThrough(RedisConstants.CACHE_SHOP_KEY,id,  </span></span><br><span class="line"><span class="comment">//             Shop.class,id2-&gt;&#123;  </span></span><br><span class="line"><span class="comment">//              return getById(id2);  </span></span><br><span class="line"><span class="comment">//             &#125;,RedisConstants.CACHE_SHOP_TTL,TimeUnit.MINUTES);  </span></span><br><span class="line">        <span class="comment">//使用工具类解决缓存击穿,  </span></span><br><span class="line">        <span class="comment">// 注意：需要提前注入缓存数据  </span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClientUtil.query_LogicalExpiration(RedisConstants.CACHE_SHOP_KEY,id,  </span><br><span class="line">                Shop.class,id2-&gt;&#123;  </span><br><span class="line">                    <span class="keyword">return</span> getById(id2);  </span><br><span class="line">                &#125;,<span class="number">20L</span>,TimeUnit.SECONDS);  </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == shop) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;该店铺信息不存在&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h1 id="优惠卷秒杀"><a href="#优惠卷秒杀" class="headerlink" title="优惠卷秒杀"></a>优惠卷秒杀</h1><p>业务场景：<br>每个店铺可以发布优惠卷，用户可以去抢购优惠卷</p>
<h2 id="全局唯一ID"><a href="#全局唯一ID" class="headerlink" title="全局唯一ID"></a>全局唯一ID</h2><ul>
<li>用户在抢购优惠卷时相关的订单信息将保存到tb_voucher_order这张表中，这张表的id没有使用自增</li>
<li>原因：</li>
</ul>
<ol>
<li>id的规律性太明显</li>
<li>受表单数量的限制</li>
</ol>
<p>解决方法：全局id生成器(是一种在分布式系统人下用来生成全局唯一Id的工具)</p>
<p>全局id生成器需要满足的特性：</p>
<ol>
<li>唯一性</li>
<li>高可用</li>
<li>高性能</li>
<li>递增性</li>
<li>安全性</li>
</ol>
<p>在使用redis作为全局id生成器时，为了增加id的安全性，不直接使用redis自增的数值，而是拼接一些其他的信息</p>
<p><strong>ID的组成部分：</strong></p>
<ol>
<li>符号位：1bit 永远为0</li>
<li>时间戳: 31bit，以秒为单位，可以使用69年</li>
<li>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同的ID</li>
</ol>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221016.19-27-00.png" alt="image-20221016192658797"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisGlobalIdGenerator</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//起始时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">START_TIME</span> <span class="operator">=</span> <span class="number">1665878400L</span>;  </span><br><span class="line">    <span class="comment">//序列号的位数  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisGlobalIdGenerator</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;  </span><br><span class="line">        <span class="comment">//生成时间戳  </span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTime.now();  </span><br><span class="line">        <span class="type">long</span> <span class="variable">NOW_TIME</span> <span class="operator">=</span> localDateTime.toEpochSecond(ZoneOffset.UTC);  </span><br><span class="line">        <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> NOW_TIME - START_TIME;  </span><br><span class="line">        <span class="comment">//生成序列号  </span></span><br><span class="line">        <span class="comment">//1.获取当前的日期  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">yyyyMMdd</span> <span class="operator">=</span> localDateTime.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));  </span><br><span class="line">        <span class="comment">//自增长  </span></span><br><span class="line">        <span class="type">long</span> <span class="variable">increment</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + yyyyMMdd);  </span><br><span class="line">        <span class="comment">//拼接并返回  </span></span><br><span class="line">        <span class="keyword">return</span> timeStamp&lt;&lt; COUNT_BITS | increment;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="comment">//生成起始时间  </span></span><br><span class="line"><span class="comment">//    public static void main(String[] args) &#123;  </span></span><br><span class="line"><span class="comment">//        LocalDateTime time = LocalDateTime.of(2022,10,16,0,0);  </span></span><br><span class="line"><span class="comment">//        long l = time.toEpochSecond(ZoneOffset.UTC);  </span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;L==&quot;+l);  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> RedisGlobalIdGenerator idGenerator;  </span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">70</span>);  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//       Runnable task = ()-&gt;&#123;  </span></span><br><span class="line"><span class="comment">//           log.debug(&quot;开始任务&quot;);  </span></span><br><span class="line"><span class="comment">//           for (int i = 0; i &lt; 100; i++) &#123;  </span></span><br><span class="line"><span class="comment">//               long id = idGenerator.nextId(&quot;test&quot;);  </span></span><br><span class="line"><span class="comment">//               System.out.println(&quot;id==&quot;+id);  </span></span><br><span class="line"><span class="comment">//           &#125;  </span></span><br><span class="line"><span class="comment">//       &#125; ;  </span></span><br><span class="line"><span class="comment">//        for (int i = 0; i &lt; 70; i++) &#123;  </span></span><br><span class="line"><span class="comment">//     //       log.debug(&quot;进入任务&quot;);  </span></span><br><span class="line"><span class="comment">//          executorService.submit(task);  </span></span><br><span class="line"><span class="comment">//        &#125;  </span></span><br><span class="line">        <span class="type">long</span> <span class="variable">test</span> <span class="operator">=</span> idGenerator.nextId(<span class="string">&quot;test&quot;</span>);  </span><br><span class="line">        System.out.println(test);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="实现优惠卷秒杀"><a href="#实现优惠卷秒杀" class="headerlink" title="实现优惠卷秒杀"></a>实现优惠卷秒杀</h2><ul>
<li><strong>下单时需要注意的地方：</strong></li>
</ul>
<ol>
<li>秒杀是否开始，或已经结束</li>
<li>库存是否足够</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> RedisGlobalIdGenerator redisGlobalIdGenerator;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="meta">@Transactional</span>    <span class="keyword">public</span> Result <span class="title function_">voucherOrder</span><span class="params">(Long voucherId)</span> &#123;  </span><br><span class="line">        <span class="comment">//1. 查询优惠卷  </span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);  </span><br><span class="line">        <span class="comment">//2. 判断秒杀是否开始  </span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;  </span><br><span class="line">            <span class="comment">//未开始  </span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;秒杀未开始&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//3. 判断秒杀是否结束  </span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;秒杀已经结束&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//4. 判断库存是否充足  </span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;优惠卷已被强光&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//5. 扣除库存  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is_success</span> <span class="operator">=</span> seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)  </span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();  </span><br><span class="line">        <span class="keyword">if</span> (!is_success) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//6. 创建订单  </span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();  </span><br><span class="line">        <span class="comment">//6.1订单id  </span></span><br><span class="line">        <span class="type">long</span> <span class="variable">order</span> <span class="operator">=</span> redisGlobalIdGenerator.nextId(<span class="string">&quot;order&quot;</span>);  </span><br><span class="line">        voucherOrder.setId(order);  </span><br><span class="line">        <span class="comment">//6.2用户id  </span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">        voucherOrder.setUserId(id);</span><br></pre></td></tr></table></figure>


<h2 id="添加乐观锁解决并发安全问题"><a href="#添加乐观锁解决并发安全问题" class="headerlink" title="添加乐观锁解决并发安全问题"></a>添加乐观锁解决并发安全问题</h2><p>解决并发安全问题的方案：</p>
<ol>
<li><strong>悲观锁：</strong> 添加同步锁，让线程串行执行</li>
</ol>
<ul>
<li>优点：简单粗暴</li>
<li>缺点：性能一般</li>
</ul>
<ol start="2">
<li><strong>乐观锁：</strong> 不加锁，在更新时判断是否有其它线程在修改</li>
</ol>
<ul>
<li><p>优点：性能好</p>
</li>
<li><p>缺点：存在成功率低的问题</p>
</li>
<li><p>乐观锁关键是判断之前查询到的数据是否又被修改</p>
</li>
<li><p>这里使用CAS法<br>这里在扣除库存这里添加乐观锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">       <span class="comment">//5. 扣除库存  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is_success</span> <span class="operator">=</span> seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)  </span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)  </span><br><span class="line">                <span class="comment">//乐观锁,这里通过查询到的优惠卷库存进行比较判断是否数据被修改  </span></span><br><span class="line">                <span class="comment">//但是这样会导致明明库存可以进行扣除却因为数据被修改而不能进行扣除  </span></span><br><span class="line"><span class="comment">//                .eq(&quot;stock&quot;,voucher.getStock()).update();  </span></span><br><span class="line">                <span class="comment">//对于这里的业务可以当库存大于0就可以进行修改  </span></span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>).update();  </span><br><span class="line">        <span class="keyword">if</span> (!is_success) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="一人一单"><a href="#一人一单" class="headerlink" title="一人一单"></a>一人一单</h2><ul>
<li>更改秒杀业务，要求同一个优惠卷，一个用户只能下一单</li>
<li>在用户下单时，先根据优惠卷id和用户id查询订单，判断是否已存在订单，若存在则阻止下单。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">voucherOrder</span><span class="params">(Long voucherId)</span> &#123;  </span><br><span class="line">    <span class="comment">//1. 查询优惠卷  </span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);  </span><br><span class="line">    <span class="comment">//2. 判断秒杀是否开始  </span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;  </span><br><span class="line">        <span class="comment">//未开始  </span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;秒杀未开始&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//3. 判断秒杀是否结束  </span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;秒杀已经结束&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//4. 判断库存是否充足  </span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;优惠卷已被强光&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//给方法上锁  </span></span><br><span class="line">    <span class="comment">//一人一单  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//给用户id上锁  </span></span><br><span class="line">    <span class="comment">//但是即使相同的id转为字符串时可能还是会导致锁的对象不一致  </span></span><br><span class="line">    <span class="comment">//因此使用.intern()返回字符串对象的规范表示，来保证id转为String对象的唯一性  </span></span><br><span class="line">    <span class="keyword">synchronized</span> (id.toString().intern()) &#123;  </span><br><span class="line">        <span class="comment">//拿到当前对象的代理对象,使用当前代理对象调用的方法才不会使事务失效  </span></span><br><span class="line">         <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span>(IVoucherOrderService) AopContext.currentProxy();  </span><br><span class="line">        <span class="comment">//返回订单id  </span></span><br><span class="line">        <span class="keyword">return</span> proxy.createOrderOrder(voucherId, id);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">createOrderOrder</span><span class="params">(Long voucherId, Long id)</span> &#123;  </span><br><span class="line">        <span class="comment">//根据优惠卷id和用户id查询是否已存在订单  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, id).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();  </span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;一个用户只能购买一次&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//5. 扣除库存  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is_success</span> <span class="operator">=</span> seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)  </span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)  </span><br><span class="line">                <span class="comment">//乐观锁,这里通过查询到的优惠卷库存进行比较判断是否数据被修改  </span></span><br><span class="line">                <span class="comment">//但是这样会导致明明库存可以进行扣除却因为数据被修改而不能进行扣除  </span></span><br><span class="line"><span class="comment">//                .eq(&quot;stock&quot;,voucher.getStock()).update();  </span></span><br><span class="line">                <span class="comment">//对于这里的业务可以当库存大于0就可以进行修改  </span></span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update();  </span><br><span class="line">        <span class="keyword">if</span> (!is_success) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;库存不足&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//6. 创建订单  </span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();  </span><br><span class="line">        <span class="comment">//6.1订单id  </span></span><br><span class="line">        <span class="type">long</span> <span class="variable">order</span> <span class="operator">=</span> redisGlobalIdGenerator.nextId(<span class="string">&quot;order&quot;</span>);  </span><br><span class="line">        voucherOrder.setId(order);  </span><br><span class="line">        <span class="comment">//6.2用户id  </span></span><br><span class="line">        voucherOrder.setUserId(id);  </span><br><span class="line">        <span class="comment">//6.3代金卷id  </span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);  </span><br><span class="line">        save(voucherOrder);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(order);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用代理对象需要注入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动类上添加注解开启</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//暴露代理对象  </span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span>  </span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hmdp.mapper&quot;)</span>  </span><br><span class="line"><span class="meta">@SpringBootApplication</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HmDianPingApplication</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        SpringApplication.run(HmDianPingApplication.class, args);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>单个jvm锁的实现<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-15-59.png"></li>
</ul>
<h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><ul>
<li><p><strong>满足分布式系统或集群模式下多进程可见并且互斥的锁</strong></p>
</li>
<li><p>当出现集群多个jvm的锁都是不一样的所以会造成线程安全问题</p>
</li>
<li><p>分布式锁通过锁监视器，使所有jvm使用锁都是同一个<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-14-21.png"></p>
</li>
</ul>
<h2 id="分布式锁的实现"><a href="#分布式锁的实现" class="headerlink" title="分布式锁的实现"></a>分布式锁的实现</h2><ul>
<li>分布式锁的核心使实现多进程之间互斥，而满足这一点的方式常见的有三种</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.14-39-24.png"></p>
<ul>
<li><strong>基于redis的分布式锁</strong></li>
</ul>
<h3 id="获取锁"><a href="#获取锁" class="headerlink" title="获取锁"></a>获取锁</h3><ul>
<li>利用setnx命令来实现<strong>互斥</strong>(确保只能有一个线程获取锁)</li>
<li>非阻塞：只尝试一次，成功返回true 失败返回false</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET lockKey value NX EX 10</span><br></pre></td></tr></table></figure>
<ol>
<li>NX代表互斥</li>
<li>EX设置超时时间(单位为秒)</li>
</ol>
<h3 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h3><ul>
<li>手动释放（删除对应的key）</li>
<li>超时释放：获取锁时添加一个超时时间</li>
</ul>
<p><strong>流程：</strong><br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.15-02-31.png"></p>
<h2 id="基于redis实现分布式锁初级版本"><a href="#基于redis实现分布式锁初级版本" class="headerlink" title="基于redis实现分布式锁初级版本"></a>基于redis实现分布式锁初级版本</h2><ul>
<li>定义一个接口&#x3D;&#x3D;ILock&#x3D;&#x3D;<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span> &#123;  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * 尝试获取锁  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeOutSec 锁持有的超时时间，过期后自动释放  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true代表获取锁成功false代表获取失败  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    Boolean <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeOutSec)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * 释放锁  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">     <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>再定义一个类实现&#x3D;&#x3D;ILock&#x3D;&#x3D;接口</li>
</ul>
<p><strong>测试：</strong></p>
<ul>
<li><p>idea服务启动两份端口号分别为8081和8082<br>在运行&#x2F;调试配置使用“CTRL”+“D”即可复制一个一模一样的运行配置，在vm进行配置&#x3D;&#x3D;-Dserver.port&#x3D;8082&#x3D;&#x3D;覆盖原来的端口号<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.16-17-32.png"></p>
</li>
<li><p>在nginx文件夹的conf文件内修改nginx.conf文件，配置反向代理和负载均衡<br>将第二个注释关闭<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.16-06-30.png"></p>
</li>
</ul>
<h2 id="解决分布式锁误删"><a href="#解决分布式锁误删" class="headerlink" title="解决分布式锁误删"></a>解决分布式锁误删</h2><ul>
<li>当线程1去获取锁执行业务时，<strong>阻塞的时间超过了锁设置的超时时间</strong>，导致锁被超时释放但是线程1还是在进行业务，</li>
<li>这时线程2由于锁被超时释放，线程则在线程1还未完成业务的情况下获取获取到了锁，而线程1完成业务时，线程2还在执行业务但是，线程1完成业务触发释放锁，将线程2的锁给释放了。</li>
<li>而线程3又可以在线程2还未完成业务的情况下继续获取到锁，此时出现了两个线程同时执行业务的错误<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-13-02.png"></li>
</ul>
<p><strong>解决方法：</strong></p>
<ul>
<li>在释放锁时判断锁的标识是否一致</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-18-08.png"></p>
<ul>
<li><strong>新的流程</strong><br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221018.18-05-50.png"></li>
</ul>
<h2 id="Lua脚本解决命令原子性问题"><a href="#Lua脚本解决命令原子性问题" class="headerlink" title="Lua脚本解决命令原子性问题"></a>Lua脚本解决命令原子性问题</h2><ul>
<li><p>redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性</p>
</li>
<li><p>redis提供的调用函数去执行redis命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;命令名称&#x27;</span>,<span class="string">&#x27;key&#x27;</span>，<span class="string">&#x27;其他参数&#x27;</span>...)</span><br></pre></td></tr></table></figure>
<p><strong>例：</strong> 执行set hello world<br>脚本是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>,<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>脚本完成后需要使用redis命令&#x3D;&#x3D;EVAL&#x3D;&#x3D;调用脚本<br><strong>例如执行redis.call(‘set’,’hello’,’world’)脚本：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL <span class="string">&quot;return redis.call(&#x27;set&#x27;,&#x27;hello&#x27;,&#x27;world&#x27;)&quot;</span> 0</span><br></pre></td></tr></table></figure></li>
</ul>
<p><u>这里的0代表参数数量</u></p>
<p>如果脚本中的key. value不想写死，可以作为参数传递。key类型参数会放入KEYS数组,其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数: </p>
<ul>
<li><strong>lua语言数组的开始是从1开始</strong><br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.13-51-55.png"></li>
</ul>
<h3 id="编写的Lua脚本："><a href="#编写的Lua脚本：" class="headerlink" title="编写的Lua脚本："></a>编写的Lua脚本：</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 锁的key</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 当前线程的标识</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 获取锁中的线程标识</span></span><br><span class="line"><span class="keyword">local</span> id = redis.call(<span class="string">&#x27;get&#x27;</span>,key)</span><br><span class="line"><span class="comment">-- 比较线程标识是否与锁标识一致</span></span><br><span class="line"><span class="keyword">if</span>(threadId==id)<span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 释放锁</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&#x27;del&#x27;</span>,key)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>


<h3 id="基于Lua脚本实现分布式锁的释放逻辑"><a href="#基于Lua脚本实现分布式锁的释放逻辑" class="headerlink" title="基于Lua脚本实现分布式锁的释放逻辑"></a>基于Lua脚本实现分布式锁的释放逻辑</h3><ul>
<li>RedisTemplate调用lua脚本的api：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.scriptExecutor.execute(script, keys, args);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.14-12-45.png"></p>
<ul>
<li>为了以后便于调整脚本内容在项目resourse文件夹下创建unlock.lua文件写入脚本</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">    <span class="keyword">private</span> String ServiceType;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;  </span><br><span class="line">    <span class="comment">//使用uuid生成标识符前缀  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;:&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String serviceType)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;  </span><br><span class="line">        ServiceType = serviceType;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//提前读取lua脚本内容  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="comment">//初始化UNLOCK_SCRIPT脚本  </span></span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();  </span><br><span class="line">        <span class="comment">//setLocation()是DefaultRedisScript提供的读取文件的方法，  </span></span><br><span class="line">        <span class="comment">// ClassPathResource()是默认从项目的resource问价下读取  </span></span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));  </span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeOutSec)</span> &#123;  </span><br><span class="line">        <span class="comment">//获取当前线程表示  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();  </span><br><span class="line">        <span class="comment">//获取锁  </span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">is_success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + ServiceType, threadId,  </span><br><span class="line">                timeOutSec, TimeUnit.SECONDS);  </span><br><span class="line">        <span class="comment">//不直接返回布尔值，避免空指针  </span></span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(is_success);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//    @Override  </span></span><br><span class="line"><span class="comment">//    public void unLock() &#123;  </span></span><br><span class="line"><span class="comment">//        //获取线程标识  </span></span><br><span class="line"><span class="comment">//        String threadId = ID_PREFIX + Thread.currentThread().getId();  </span></span><br><span class="line"><span class="comment">//        //获取redis锁中的标识  </span></span><br><span class="line"><span class="comment">//        String s = stringRedisTemplate.opsForValue().get(ID_PREFIX + ServiceType);  </span></span><br><span class="line"><span class="comment">//        if (threadId.equals(s)) &#123;  </span></span><br><span class="line"><span class="comment">//            stringRedisTemplate.delete(KEY_PREFIX + ServiceType);  </span></span><br><span class="line"><span class="comment">//        &#125;  </span></span><br><span class="line"><span class="comment">//    &#125;  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="comment">//调用lua脚本  </span></span><br><span class="line">        stringRedisTemplate.execute(UNLOCK_SCRIPT,  </span><br><span class="line">                Collections.singletonList(KEY_PREFIX + ServiceType),  </span><br><span class="line">                ID_PREFIX + Thread.currentThread().getId());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>基于redis的分布式锁的实现思路：</strong></p>
<ul>
<li>利用set nx ex 获取锁，并设置过期时间，保存线程标识</li>
<li>释放锁时先判断标识是否与自己的一致，一致才删除</li>
</ul>
<p><strong>特性：</strong></p>
<ol>
<li>利用set nx满足互斥性</li>
<li>利用set ex保证故障时锁依然能释放，避免死锁，提高安全性</li>
<li>利用redis集群保证高可用和高并发特性</li>
</ol>
<h1 id="基于redis分布式锁的优化"><a href="#基于redis分布式锁的优化" class="headerlink" title="基于redis分布式锁的优化"></a>基于redis分布式锁的优化</h1><ul>
<li>基于setnx实现的分布式锁存在下面的问题：</li>
</ul>
<ol>
<li><strong>不可重入：</strong> 同一个线程无法多次获取同一把锁</li>
<li><strong>不可重试：</strong> 获取锁只能尝试一次，没有重试机制</li>
<li><strong>超时释放：</strong> 锁超时释放虽然可以避免死锁，但如果是业务执行耗时较长，也会导致锁释放存在安全隐患</li>
<li><strong>主从一致性：</strong> 如果redis提供了主从集群，主从同步存在延迟可能会出现问题</li>
</ol>
<h2 id="Redisson"><a href="#Redisson" class="headerlink" title="Redisson"></a>Redisson</h2><ul>
<li>redisson是一个在redis的基础上实现的Java驻内存数据网格(In-Memory Data Grid)，它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现<br>GitHub：<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">redisson&#x2F;redisson: Redisson - Redis Java client with features of In-Memory Data Grid.(github.com)</a></li>
</ul>
<h2 id="Redisson入门"><a href="#Redisson入门" class="headerlink" title="Redisson入门"></a>Redisson入门</h2><ol>
<li><p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.redisson/redisson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建配置类配置Redisson客户端</strong></p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="comment">//配置类  </span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();  </span><br><span class="line">        <span class="comment">//添加redis地址，这里添加了单点地址，  </span></span><br><span class="line">        <span class="comment">//也可以使用config.useClusterServers()添加集群地址,有密码的话再.setPassword()设置密码  </span></span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.157.129:6379&quot;</span>);  </span><br><span class="line">        <span class="comment">//创建客户端  </span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<ol start="3">
<li><strong>对原来的代码进行改造：</strong></li>
</ol>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221019.16-10-32.png"></p>
<ul>
<li>这里只是将原来的strRedisTemplate锁改为了Redisson提供的锁，业务逻辑没有发送改变<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//使用redis分布锁给用户id上锁  </span></span><br><span class="line"><span class="comment">//   SimpleRedisLock simpleRedisLock = new SimpleRedisLock(stringRedisTemplate, &quot;order:&quot; + id);  </span></span><br><span class="line">   <span class="comment">//使用redisson获取锁  </span></span><br><span class="line">   <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + id);  </span><br><span class="line">   <span class="comment">//获取锁  注意设置的超时时间与具体的业务有关  </span></span><br><span class="line">   <span class="type">Boolean</span> <span class="variable">is_lock</span> <span class="operator">=</span> lock.tryLock();  </span><br><span class="line">   <span class="keyword">if</span> (!is_lock) &#123;  </span><br><span class="line">       <span class="comment">//获取锁失败，根据具体业务返回错误信息或重试  </span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;重复下单失败&quot;</span>);  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">try</span> &#123;  </span><br><span class="line">       <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();  </span><br><span class="line">       <span class="keyword">return</span> proxy.createOrderOrder(voucherId, id);  </span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">       <span class="comment">//当业务出现异常时，保证锁一定被释放  </span></span><br><span class="line">     lock.unlock();  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Redisson可重入锁原理"><a href="#Redisson可重入锁原理" class="headerlink" title="Redisson可重入锁原理"></a>Redisson可重入锁原理</h2><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.08-42-45.png"></p>
<h2 id="Redisson分布式锁原理"><a href="#Redisson分布式锁原理" class="headerlink" title="Redisson分布式锁原理"></a>Redisson分布式锁原理</h2><ul>
<li><strong>可重入：</strong> 利用hash结构记录线程id和可重入次数</li>
<li><strong>可重试：</strong> 利用信号量和PubSub功能实现等待，唤醒，获取锁失败的重试机制</li>
<li><strong>超时续约：</strong> 利用watchDog,每隔一段时间，重置超时时间</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.09-08-17.png"></p>
<h2 id="Redisson分布式锁主从一致性问题"><a href="#Redisson分布式锁主从一致性问题" class="headerlink" title="Redisson分布式锁主从一致性问题"></a>Redisson分布式锁主从一致性问题</h2><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.09-42-00.png"></p>
<h1 id="基于阻塞队列的异步秒杀"><a href="#基于阻塞队列的异步秒杀" class="headerlink" title="基于阻塞队列的异步秒杀"></a>基于阻塞队列的异步秒杀</h1><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.10-20-36.png"></p>
<ul>
<li>新增秒杀优惠卷的同时将优惠卷信息保存到redis中<br>在VoucherServiceImpl的addSeckillVoucher方法进行修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="meta">@Transactional</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;  </span><br><span class="line">        <span class="comment">// 保存优惠券  </span></span><br><span class="line">        save(voucher);  </span><br><span class="line">        <span class="comment">// 保存秒杀信息  </span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();  </span><br><span class="line">        seckillVoucher.setVoucherId(voucher.getId());  </span><br><span class="line">        seckillVoucher.setStock(voucher.getStock());  </span><br><span class="line">        seckillVoucher.setBeginTime(voucher.getBeginTime());  </span><br><span class="line">        seckillVoucher.setEndTime(voucher.getEndTime());  </span><br><span class="line">        seckillVoucherService.save(seckillVoucher);  </span><br><span class="line">        <span class="comment">//保存优惠卷库存信息到redis  </span></span><br><span class="line">        stringRedisTemplate.opsForValue().  </span><br><span class="line">                set(RedisConstants.SECKILL_STOCK_KEY+voucher.getId(),  </span><br><span class="line">                        voucher.getStock().toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>基于lua脚本，判断秒杀库存，一人一单，判断用户是否抢购成功<br>lua脚本：</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 优惠卷id  </span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]  </span><br><span class="line"><span class="comment">-- 用户id  </span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]  </span><br><span class="line"><span class="comment">-- 库存key  </span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId  </span><br><span class="line"><span class="comment">-- 订单key  </span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId  </span><br><span class="line"><span class="comment">-- 判断库存是否充足  </span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>,stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span>  </span><br><span class="line">    <span class="comment">-- 库存不足，返回1  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 判断用户是否下单  </span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;SISMEMBER&#x27;</span>,orderKey,userId)==<span class="number">1</span>) <span class="keyword">then</span>  </span><br><span class="line">    <span class="comment">-- 存在重复下单返回2  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 扣除库存  </span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>,stockKey,<span class="number">-1</span>)  </span><br><span class="line"><span class="comment">-- 下单  </span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>,orderKey,userId)  </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 抢购成功后，将优惠卷id和用户id封装后存入阻塞队列</span><br><span class="line"></span><br><span class="line">- 开启线程任务，不断从阻塞队列中获取信息，实现异步下单</span><br><span class="line">```java</span><br><span class="line">@Service  </span><br><span class="line">@Slf4j  </span><br><span class="line">public class VoucherOrderServiceImpl extends ServiceImpl&lt;VoucherOrderMapper, VoucherOrder&gt; implements IVoucherOrderService &#123;  </span><br><span class="line">  </span><br><span class="line">    @Resource  </span><br><span class="line">    private ISeckillVoucherService seckillVoucherService;  </span><br><span class="line">  </span><br><span class="line">    @Resource  </span><br><span class="line">    private RedisGlobalIdGenerator redisGlobalIdGenerator;  </span><br><span class="line">  </span><br><span class="line">    @Resource  </span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    @Resource  </span><br><span class="line">    private RedissonClient redissonClient;  </span><br><span class="line">    //提前读取lua脚本内容  </span><br><span class="line">    private static final DefaultRedisScript&lt;Long&gt; JUDGE_ORDER_SCRIPT;  </span><br><span class="line">  </span><br><span class="line">    static &#123;  </span><br><span class="line">        //初始化UNLOCK_SCRIPT脚本  </span><br><span class="line">        JUDGE_ORDER_SCRIPT = new DefaultRedisScript&lt;&gt;();  </span><br><span class="line">        //setLocation()是DefaultRedisScript提供的读取文件的方法，  </span><br><span class="line">        // ClassPathResource()是默认从项目的resource问价下读取  </span><br><span class="line">        JUDGE_ORDER_SCRIPT.setLocation(new ClassPathResource(<span class="string">&quot;JudgeTheOrder.lua&quot;</span>));  </span><br><span class="line">        JUDGE_ORDER_SCRIPT.setResultType(Long.class);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    //创建阻塞队列  </span><br><span class="line">    private BlockingQueue&lt;VoucherOrder&gt; blockingQueue = new ArrayBlockingQueue&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">    //创建异步下单的线程  </span><br><span class="line">    private static final ExecutorService executorService = Executors.newSingleThreadExecutor();  </span><br><span class="line">    //PostConstruct是spring提供的注解当这个类一但完成初始化时就执行注解下的方法  </span><br><span class="line">    @PostConstruct  </span><br><span class="line">    private void init()&#123;  </span><br><span class="line">        executorService.submit(new VoucherOrderTask());  </span><br><span class="line">    &#125;  </span><br><span class="line">    //下单的任务  </span><br><span class="line">   private class  VoucherOrderTask implements Runnable&#123;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public void run() &#123;  </span><br><span class="line">            //不断从队列中获取订单信息，创建订单  </span><br><span class="line">           <span class="keyword">while</span> (<span class="literal">true</span>)&#123;  </span><br><span class="line">               try &#123;  </span><br><span class="line">                   VoucherOrder voucherOrder = blockingQueue.take();  </span><br><span class="line">                   //创建订单  </span><br><span class="line">                   handleVoucherOrder(voucherOrder);  </span><br><span class="line">               &#125; catch (Exception e) &#123;  </span><br><span class="line">                   <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;订单处理异常&quot;</span>,e);  </span><br><span class="line">               &#125;  </span><br><span class="line">           &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    private void handleVoucherOrder(VoucherOrder voucherOrder) &#123;  </span><br><span class="line">        Long id = voucherOrder.getUserId();  </span><br><span class="line">        //使用redisson获取锁  </span><br><span class="line">        RLock lock = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + id);  </span><br><span class="line">        //获取锁  注意设置的超时时间与具体的业务有关  </span><br><span class="line">        Boolean is_lock = lock.tryLock();  </span><br><span class="line">        <span class="keyword">if</span> (!is_lock) &#123;  </span><br><span class="line">            //获取锁失败，根据具体业务返回错误信息或重试  </span><br><span class="line">             <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;重复下单失败&quot;</span>);  </span><br><span class="line">             <span class="keyword">return</span>;        &#125;  </span><br><span class="line">        try &#123;  </span><br><span class="line">           proxy.createOrderOrder(voucherOrder);  </span><br><span class="line">        &#125; finally &#123;  </span><br><span class="line">            //当业务出现异常时，保证锁一定被释放  </span><br><span class="line">          lock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    private  IVoucherOrderService proxy;  </span><br><span class="line">    @Override  </span><br><span class="line">    public Result voucherOrder(Long voucherId) &#123;  </span><br><span class="line">        //获取用户id  </span><br><span class="line">        Long id = UserHolder.getUser().getId();  </span><br><span class="line">        //执行lua脚本  </span><br><span class="line">        Long result = stringRedisTemplate.<span class="built_in">execute</span>(JUDGE_ORDER_SCRIPT,  </span><br><span class="line">                Collections.emptyList(), voucherId.toString(), id.toString());  </span><br><span class="line">        //判断结果，为<span class="number">0</span>可以去下单  </span><br><span class="line">        int i = result.intValue();  </span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span>!=i)&#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="number">1</span> == i ?<span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        //可以下单，  </span><br><span class="line">        long orderId = redisGlobalIdGenerator.nextId(<span class="string">&quot;order&quot;</span>);  </span><br><span class="line">        //封装  </span><br><span class="line">        VoucherOrder voucherOrder = new VoucherOrder();  </span><br><span class="line">        long order = redisGlobalIdGenerator.nextId(<span class="string">&quot;order&quot;</span>);  </span><br><span class="line">        voucherOrder.setId(order);  </span><br><span class="line">        voucherOrder.setUserId(id);  </span><br><span class="line">        voucherOrder.setVoucherId(voucherId);  </span><br><span class="line">        //将下单信息放入阻塞队列  </span><br><span class="line">        blockingQueue.add(voucherOrder);  </span><br><span class="line">        //获取代理对象  </span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    @Transactional  </span><br><span class="line">    public  void createOrderOrder(VoucherOrder voucherOrder) &#123;  </span><br><span class="line">        //根据优惠卷id和用户id查询是否已存在订单  </span><br><span class="line">        Long userId = voucherOrder.getUserId();  </span><br><span class="line">        int count = query().eq(<span class="string">&quot;user_id&quot;</span>,userId).eq(<span class="string">&quot;voucher_id&quot;</span>,voucherOrder.getVoucherId()).count();  </span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;无法重复下单&quot;</span>);  </span><br><span class="line">            <span class="keyword">return</span> ;        &#125;  </span><br><span class="line">        //<span class="number">5.</span> 扣除库存  </span><br><span class="line">        boolean is_success = seckillVoucherService.update().setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)  </span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>,voucherOrder.getVoucherId())  </span><br><span class="line">                //乐观锁,这里通过查询到的优惠卷库存进行比较判断是否数据被修改  </span><br><span class="line">                //但是这样会导致明明库存可以进行扣除却因为数据被修改而不能进行扣除  </span><br><span class="line">//                .eq(<span class="string">&quot;stock&quot;</span>,voucher.getStock()).update();  </span><br><span class="line">                //对于这里的业务可以当库存大于<span class="number">0</span>就可以进行修改  </span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update();  </span><br><span class="line">        <span class="keyword">if</span> (!is_success) &#123;  </span><br><span class="line">            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;库存不足&quot;</span>);  </span><br><span class="line">            <span class="keyword">return</span> ;        &#125;  </span><br><span class="line">        //<span class="number">6.</span> 创建订单  </span><br><span class="line">         save(voucherOrder);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Redis实现消息队列实现异步秒杀"><a href="#Redis实现消息队列实现异步秒杀" class="headerlink" title="Redis实现消息队列实现异步秒杀"></a>Redis实现消息队列实现异步秒杀</h1><h2 id="基于List结构模拟消息队列"><a href="#基于List结构模拟消息队列" class="headerlink" title="基于List结构模拟消息队列"></a>基于List结构模拟消息队列</h2><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.15-56-22.png"><br>优点：</p>
<ol>
<li>利用redis存储，不受限于JVM内存上限</li>
<li>基于redis的持久化机制，数据安全性有保证</li>
<li>可以满足消息有序性</li>
</ol>
<p>缺点：</p>
<ol>
<li>无法避免消息丢失</li>
<li>只支持单消费者</li>
</ol>
<h2 id="基于PubSub的消息队列"><a href="#基于PubSub的消息队列" class="headerlink" title="基于PubSub的消息队列"></a>基于PubSub的消息队列</h2><blockquote>
<p>pubSub是redis2.0引入的消息传递模型，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后所有订阅者都能收到相关消息。</p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-10-45.png"><br>优点：</p>
<ol>
<li>采用发布订阅模型，支持多生产，多消费<br>缺点：</li>
<li>不支持数据持久化</li>
<li>无法避免消息丢失</li>
<li>消息堆积有上限，超出时数据丢失</li>
</ol>
<h2 id="基于Stream的消息队列"><a href="#基于Stream的消息队列" class="headerlink" title="基于Stream的消息队列"></a>基于Stream的消息队列</h2><blockquote>
<p>Stream是redis5.0引入的一种新的数据类型，可以实现一个功能非常完善的消息队列</p>
</blockquote>
<p><strong>发送消息的命令&#x3D;&#x3D;XADD&#x3D;&#x3D;:</strong><br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-18-13.png"></p>
<p>例：</p>
<ul>
<li>创建名为users的队列，并向其中发送一个消息，内容是{name&#x3D;bob,age&#x3D;21}，并且使用redis自动生成id</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xadd <span class="built_in">users</span> * name bob age 21</span><br></pre></td></tr></table></figure>

<p><strong>读取消息方式之一XREAD：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-23-13.png"></p>
<p>例：<br>读取user队列中的第一个消息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xread count 1 streams <span class="built_in">users</span> 0</span><br></pre></td></tr></table></figure>

<p>XREAD阻塞方式读取最新的消息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xread count 1 block 1000 streams <span class="built_in">users</span> $</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-36-51.png"></p>
<p><strong>特点：</strong></p>
<ul>
<li>消息可回溯</li>
<li>一个消息可以被多个消费者读取</li>
<li>可以阻塞读取</li>
<li>有消息漏读的风险</li>
</ul>
<h2 id="基于stream的消息队列-消费者组"><a href="#基于stream的消息队列-消费者组" class="headerlink" title="基于stream的消息队列-消费者组"></a>基于stream的消息队列-消费者组</h2><ul>
<li>消费者组：将多个消费者划分到一个组中，监听同一个队列，特点：</li>
</ul>
<ol>
<li><strong>消息分流：</strong> 队列中的消息会分流给组内的不同消费者，而不是重复消费，来加快消息处理的速度</li>
<li><strong>消息标示：</strong> 消费者组会维护一个标示，记录最后一个被处理的消息，哪怕消费者宕机重启，还会从表示之后读取消息，确保每一个消息都会被消费</li>
<li><strong>消息确认：</strong> 消费者读取消息后，消息处于pending状态，并存入一个pending-list。当处理完成后需要通过XACK来确认消息，标记消息为已处理，才会从pending-list移除</li>
</ol>
<p><strong>创建消费者组:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure>
<ul>
<li>key:队列名称</li>
<li>groupName：消费者组名称</li>
<li>ID：起始ID表示，$代表队列中最后一个消息，0代表队列中第一个消息</li>
<li>MKSTREAM : 当队列不存在时自动创建队列</li>
</ul>
<p><strong>其他常见命令：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-52-00.png"></p>
<p><strong>从消费者组读取消息：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.16-54-31.png"></p>
<p><strong>STREANM类型消息队列的XREADGROUP命令特点：</strong></p>
<ul>
<li><p>消息可回溯</p>
</li>
<li><p>可以多消费者争抢消息，加快消费速度</p>
</li>
<li><p>可以阻塞读取</p>
</li>
<li><p>没有消息漏读的风险</p>
</li>
<li><p>有消息确认机制，保证消息至少被消费一次</p>
</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221020.17-06-38.png"></p>
<h2 id="redis的stream结构作为消息队列，实现异步秒杀下单"><a href="#redis的stream结构作为消息队列，实现异步秒杀下单" class="headerlink" title="redis的stream结构作为消息队列，实现异步秒杀下单"></a>redis的stream结构作为消息队列，实现异步秒杀下单</h2><ol>
<li><p>在redis客户端，创建一个stream类型的消息队列stream.orders </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE stream.orders g1 0 MKSTREAM</span><br></pre></td></tr></table></figure>

</li>
<li><p>修改之前秒杀下单的lua脚本，在认定有抢购资格后，直接向stream.orders中添加消息，内容包含voucherId,userId,orderId</p>
</li>
</ol>
<ul>
<li><strong>lua脚本：</strong><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-- 优惠卷id  </span><br><span class="line"><span class="type">local</span> <span class="variable">voucherId</span> <span class="operator">=</span> ARGV[<span class="number">1</span>]  </span><br><span class="line">-- 用户id  </span><br><span class="line"><span class="type">local</span> <span class="variable">userId</span> <span class="operator">=</span> ARGV[<span class="number">2</span>]  </span><br><span class="line">-- 订单id  </span><br><span class="line"><span class="type">local</span> <span class="variable">orderId</span> <span class="operator">=</span> ARGV[<span class="number">3</span>]  </span><br><span class="line">-- 库存key  </span><br><span class="line"><span class="type">local</span> <span class="variable">stockKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId  </span><br><span class="line">-- 订单key  </span><br><span class="line"><span class="type">local</span> <span class="variable">orderKey</span> <span class="operator">=</span> <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId  </span><br><span class="line">-- 判断库存是否充足  </span><br><span class="line"><span class="keyword">if</span>(tonumber(redis.call(<span class="string">&quot;get&quot;</span>,stockKey)) &lt;= <span class="number">0</span>) then  </span><br><span class="line">    -- 库存不足，返回<span class="number">1</span>  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>  </span><br><span class="line">end  </span><br><span class="line">-- 判断用户是否下单  </span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;SISMEMBER&#x27;</span>,orderKey,userId)==<span class="number">1</span>) then  </span><br><span class="line">    -- 存在重复下单返回<span class="number">2</span>  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>  </span><br><span class="line">end  </span><br><span class="line">-- 扣除库存  </span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>,stockKey,-<span class="number">1</span>)  </span><br><span class="line">-- 下单  </span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>,orderKey,userId)  </span><br><span class="line">  </span><br><span class="line">-- 发送消息到队列中 XADD stream.orders * k1 v1 k2 v2...redis.call(<span class="string">&#x27;XADD&#x27;</span>,<span class="string">&#x27;stream.orders&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;userId&#x27;</span>,userId,<span class="string">&#x27;voucherId&#x27;</span>,voucherId,<span class="string">&#x27;id&#x27;</span>,orderId)  </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  IVoucherOrderService proxy;  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">voucherOrder</span><span class="params">(Long voucherId)</span> &#123;  </span><br><span class="line">    <span class="comment">//获取用户id  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//获取订单id  </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisGlobalIdGenerator.nextId(<span class="string">&quot;order&quot;</span>);  </span><br><span class="line">    <span class="comment">//执行lua脚本  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(JUDGE_ORDER_SCRIPT,  </span><br><span class="line">            Collections.emptyList(),  </span><br><span class="line">            voucherId.toString(),id.toString(),String.valueOf(orderId));  </span><br><span class="line">    <span class="comment">//判断结果，为0可以去下单  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> result.intValue();  </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span>!=i)&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="number">1</span> == i ?<span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//获取代理对象  </span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>项目启动时，开启一个线程任务，尝试获取stream.orders中的消息，完成下单<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="comment">//从消息队列中获取订单信息，创建订单  </span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; mapRecords = stringRedisTemplate.opsForStream().read(  </span><br><span class="line">                        <span class="comment">//从哪一个组中读取  </span></span><br><span class="line">                        Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),  </span><br><span class="line">                        <span class="comment">//指定读取的数量并设置阻塞时间为2秒  </span></span><br><span class="line">                        StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),  </span><br><span class="line">                        StreamOffset.create(queueName, ReadOffset.lastConsumed())  </span><br><span class="line">                );  </span><br><span class="line">                <span class="comment">//判断消息是否获取成功  </span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == mapRecords || mapRecords.isEmpty()) &#123;  </span><br><span class="line">                    <span class="comment">//获取失败没有消息，继续下一次读取  </span></span><br><span class="line">                    <span class="keyword">continue</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="comment">//获取成功，解析订单消息  </span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; entries = mapRecords.get(<span class="number">0</span>);  </span><br><span class="line">                Map&lt;Object, Object&gt; value = entries.getValue();  </span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);  </span><br><span class="line">                <span class="comment">//创建订单  </span></span><br><span class="line">                handleVoucherOrder(voucherOrder);  </span><br><span class="line">                <span class="comment">//ACK确认  </span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, entries.getId());  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                <span class="comment">//出现异常时确认消息  </span></span><br><span class="line">                handlePendingList();  </span><br><span class="line">                log.error(<span class="string">&quot;订单处理异常&quot;</span>, e);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">//从消息队列中获取订单信息，创建订单  </span></span><br><span class="line">            List&lt;MapRecord&lt;String, Object, Object&gt;&gt; mapRecords = stringRedisTemplate.opsForStream().read(  </span><br><span class="line">                    <span class="comment">//从哪一个组中读取  </span></span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),  </span><br><span class="line">                    <span class="comment">//指定读取的数量并设置阻塞时间为2秒  </span></span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),  </span><br><span class="line">                    StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>))  </span><br><span class="line">            );  </span><br><span class="line">            <span class="comment">//判断消息是否获取成功  </span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == mapRecords || mapRecords.isEmpty()) &#123;  </span><br><span class="line">                <span class="comment">//获取失败没有消息，pendingLIst中没有异常消息，循环结束  </span></span><br><span class="line">               <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">//获取成功，解析订单消息  </span></span><br><span class="line">            MapRecord&lt;String, Object, Object&gt; entries = mapRecords.get(<span class="number">0</span>);  </span><br><span class="line">            Map&lt;Object, Object&gt; value = entries.getValue();  </span><br><span class="line">            <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);  </span><br><span class="line">            <span class="comment">//创建订单  </span></span><br><span class="line">            handleVoucherOrder(voucherOrder);  </span><br><span class="line">            <span class="comment">//ACK确认  </span></span><br><span class="line">            stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, entries.getId());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            log.error(<span class="string">&quot;pendingList异常&quot;</span>, e);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                Thread.sleep(<span class="number">50</span>);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;  </span><br><span class="line">                ex.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="点评功能"><a href="#点评功能" class="headerlink" title="点评功能"></a>点评功能</h1><h2 id="完善发布点评"><a href="#完善发布点评" class="headerlink" title="完善发布点评"></a>完善发布点评</h2><ul>
<li>发布功能接口完善<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> IUserService userService;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;  </span><br><span class="line">        <span class="comment">// 根据用户查询  </span></span><br><span class="line">        Page&lt;Blog&gt; page =query()  </span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)  </span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));  </span><br><span class="line">        <span class="comment">// 获取当前页数据  </span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();  </span><br><span class="line">        <span class="comment">// 查询用户  </span></span><br><span class="line">        records.forEach(blog -&gt;&#123;  </span><br><span class="line">            userQuery(blog);  </span><br><span class="line">        &#125;);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">userQuery</span><span class="params">(Blog blog)</span> &#123;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);  </span><br><span class="line">        blog.setName(user.getNickName());  </span><br><span class="line">        blog.setIcon(user.getIcon());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);  </span><br><span class="line">        <span class="keyword">if</span> (blog==<span class="literal">null</span>)&#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;不存在！！&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//查询有关用户id,并封装数据  </span></span><br><span class="line">        userQuery(blog);  </span><br><span class="line">        <span class="keyword">return</span>  Result.ok(blog);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="完善点赞功能实现"><a href="#完善点赞功能实现" class="headerlink" title="完善点赞功能实现"></a>完善点赞功能实现</h2><ul>
<li>同一个用户只能对一个点赞一次，再次单击取消点赞</li>
<li>如果当前用户已经点赞，则点赞按钮高亮显示(前端通过判断blog类的isLike属性)</li>
</ul>
<p>实现步骤：</p>
<ol>
<li>给blog类中添加一个isLike字段标识是否被当前用户点赞</li>
<li>利用redis的set集合判断是否点过赞，没有点赞数加1，有则数量减1</li>
<li>修改根据id查询blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</li>
<li>修改分页查询blog业务，判断当前用户是否点赞过，复制给isLike字段</li>
</ol>
<ul>
<li>添加字段，@TableField(exist &#x3D; false)  注解表示不属于数据库表的字段<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 是否点赞过了  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@TableField(exist = false)</span>  </span><br><span class="line"><span class="keyword">private</span> Boolean isLike;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> IUserService userService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;  </span><br><span class="line">        <span class="comment">// 根据用户查询  </span></span><br><span class="line">        Page&lt;Blog&gt; page = query()  </span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)  </span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));  </span><br><span class="line">        <span class="comment">// 获取当前页数据  </span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();  </span><br><span class="line">        <span class="comment">// 查询用户  </span></span><br><span class="line">        records.forEach(blog -&gt; &#123;  </span><br><span class="line">            userQuery(blog);  </span><br><span class="line">            BlogIsLiked(blog);  </span><br><span class="line">        &#125;);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">userQuery</span><span class="params">(Blog blog)</span> &#123;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();  </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);  </span><br><span class="line">        blog.setName(user.getNickName());  </span><br><span class="line">        blog.setIcon(user.getIcon());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);  </span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;不存在！！&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//查询有关用户id,并封装数据  </span></span><br><span class="line">        userQuery(blog);  </span><br><span class="line">        <span class="comment">//查询是否被点赞  </span></span><br><span class="line">        BlogIsLiked(blog);  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">BlogIsLiked</span><span class="params">(Blog blog)</span> &#123;  </span><br><span class="line">        <span class="comment">//获取当前用户  </span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">        <span class="comment">//判断用户是否已点赞  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> +  blog.getId();  </span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">is_member</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, usrId.toString());  </span><br><span class="line">        blog.setIsLike(BooleanUtil.isTrue(is_member));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">        <span class="comment">//获取当前用户  </span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">        <span class="comment">//判断用户是否已点赞  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + id;  </span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">is_member</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, usrId.toString());  </span><br><span class="line">        <span class="keyword">if</span> (BooleanUtil.isFalse(is_member)) &#123;  </span><br><span class="line">            <span class="comment">//未点赞,点赞数加1  </span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();  </span><br><span class="line">            <span class="comment">//保存用户到set集合  </span></span><br><span class="line">            <span class="keyword">if</span> (b) &#123;  </span><br><span class="line">                stringRedisTemplate.opsForSet().add(key, usrId.toString());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="comment">//已点赞，点赞数减1  </span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();  </span><br><span class="line">            <span class="comment">//blog中的set集合中移除当前用户  </span></span><br><span class="line">            <span class="keyword">if</span> (b) &#123;  </span><br><span class="line">                stringRedisTemplate.opsForSet().remove(key,usrId.toString());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> Result.ok();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="点赞排行"><a href="#点赞排行" class="headerlink" title="点赞排行"></a>点赞排行</h2><ul>
<li><p>按照点赞时间先后排序，返回前5个点赞的用户</p>
</li>
<li><p>使用redis的&#x3D;&#x3D;有序集合sorted set&#x3D;&#x3D;，将点赞用户的时间作为分数(score)进行排序</p>
</li>
<li><p>在判判断成员是否存在时，由于没有set集合中的&#x3D;&#x3D;.isMember&#x3D;&#x3D;方法进行判断，所以这里使用&#x3D;&#x3D;.score&#x3D;&#x3D;方法查询当前成员的排序分数，若用户不存在则返回空</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">    <span class="comment">//获取当前用户  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//判断用户是否已点赞  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + id;  </span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, usrId.toString());  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == score) &#123;  </span><br><span class="line">        <span class="comment">//未点赞,点赞数加1  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();  </span><br><span class="line">        <span class="comment">//保存用户到set集合  </span></span><br><span class="line">        <span class="keyword">if</span> (b) &#123;  </span><br><span class="line">            stringRedisTemplate.opsForZSet().add(key, usrId.toString(), System.currentTimeMillis());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">//已点赞，点赞数减1  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();  </span><br><span class="line">        <span class="comment">//blog中的set集合中移除当前用户  </span></span><br><span class="line">        <span class="keyword">if</span> (b) &#123;  </span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(key, usrId.toString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Result.ok();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">BlogIsLiked</span><span class="params">(Blog blog)</span> &#123;  </span><br><span class="line">    <span class="comment">//获取当前用户  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//判断用户是否已点赞  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + blog.getId();  </span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, usrId.toString());  </span><br><span class="line">    blog.setIsLike(<span class="literal">null</span> != score);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="好友关注"><a href="#好友关注" class="headerlink" title="好友关注"></a>好友关注</h1><h2 id="关注和取关接口实现"><a href="#关注和取关接口实现" class="headerlink" title="关注和取关接口实现"></a>关注和取关接口实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followId, Boolean isFollow)</span> &#123;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">usrID</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">        <span class="keyword">if</span> (isFollow)&#123;  </span><br><span class="line">            <span class="comment">//关注，新增数据  </span></span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();  </span><br><span class="line">            follow.setUserId(usrID);  </span><br><span class="line">            follow.setFollowUserId(followId);  </span><br><span class="line">            save(follow);  </span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="comment">//取关，删除数据  </span></span><br><span class="line">            remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()  </span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>,usrID)  </span><br><span class="line">                    .eq(<span class="string">&quot;follow_user_id&quot;</span>,followId));  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followId)</span> &#123;  </span><br><span class="line">        <span class="type">Long</span> <span class="variable">usrID</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, usrID)  </span><br><span class="line">                .eq(<span class="string">&quot;follow_user_id&quot;</span>, followId).count();  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(count&gt;<span class="number">0</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="共同关注功能实现"><a href="#共同关注功能实现" class="headerlink" title="共同关注功能实现"></a>共同关注功能实现</h2><ul>
<li>利用redis的set集合将用户关注的对象id和用户的id存入set集合</li>
<li>当用户查看另一个用户的共同关注时，则查询两个用户之间的相同</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span>  </span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followId, Boolean isFollow)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrID</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follow:&quot;</span>+usrID;  </span><br><span class="line">    <span class="keyword">if</span> (isFollow)&#123;  </span><br><span class="line">        <span class="comment">//关注，新增数据  </span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();  </span><br><span class="line">        follow.setUserId(usrID);  </span><br><span class="line">        follow.setFollowUserId(followId);  </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);  </span><br><span class="line">        <span class="keyword">if</span> (isSuccess)&#123;  </span><br><span class="line">            <span class="comment">//将关注的用户id放入redis的set集合  </span></span><br><span class="line">        stringRedisTemplate.opsForSet().add(key,followId.toString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">//取关，删除数据  </span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()  </span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, usrID)  </span><br><span class="line">                .eq(<span class="string">&quot;follow_user_id&quot;</span>, followId));  </span><br><span class="line">        <span class="keyword">if</span> (isSuccess)&#123;  </span><br><span class="line">            <span class="comment">//将关注的用户id移出redis的set集合  </span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followId.toString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> Result.ok();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>set集合的.intersect方法传入连个key，就可以查询两个key之间的交集</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followComment</span><span class="params">(Long id)</span> &#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrID</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//当前用户关注的集合的key  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follow:&quot;</span> + usrID;  </span><br><span class="line">    <span class="comment">//要查询的用户关注集合的key  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follow:&quot;</span> + id;  </span><br><span class="line">    <span class="comment">//set集合的.intersect方法传入连个key，就可以查询两个key之间的交集  </span></span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == intersect || intersect.isEmpty()) &#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//解析id，查询用户  </span></span><br><span class="line">    List&lt;Long&gt; collect = intersect.stream()  </span><br><span class="line">            .map(Long::valueOf)  </span><br><span class="line">            .collect(Collectors.toList());  </span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.listByIds(collect)  </span><br><span class="line">            .stream()  </span><br><span class="line">            .map(user -&gt;  </span><br><span class="line">                    BeanUtil.copyProperties(user, UserDTO.class)  </span><br><span class="line">            ).collect(Collectors.toList());  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关注推送"><a href="#关注推送" class="headerlink" title="关注推送"></a>关注推送</h2><blockquote>
<p>关注推送也叫做feed流，为用户持续的提供”沉浸式“的体验，通过无限下拉刷新获取新的信息</p>
</blockquote>
<h2 id="Feed流模式"><a href="#Feed流模式" class="headerlink" title="Feed流模式"></a>Feed流模式</h2><p>feed流两种常见模式：</p>
<ol>
<li><strong>TimeLine:</strong> 不做内容筛选，简单的按照内容发布时间排序</li>
</ol>
<ul>
<li>优点：信息全面，不会有缺失，且实现简单</li>
<li>缺点：信息噪音较多，内容获取效率低</li>
</ul>
<ol start="2">
<li><strong>智能排序：</strong> 利用智能算法屏蔽掉违规，用户不感兴趣的内容，推送用户感兴趣的信息</li>
</ol>
<ul>
<li>优点：用户黏度高</li>
<li>缺点：需要高准确的算法</li>
</ul>
<p><u>在这里使用TimeLine模式</u></p>
<p>TimeLine的实现方案也有三种：<br><strong>1. 拉模式</strong></p>
<ul>
<li>也称为读扩散</li>
</ul>
<p>发消息的用户将带有时间戳的消息发送到发件箱，收消息的用户只有在读取消息时，才会将该用户关注的人发送的消息从发件箱拉取到该用户的收件箱，再将消息按时间排序。<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.15-53-49.png"></p>
<p>优点：节省空间(只有读取消息时才，拉取消息到收件箱，收件箱的消息每次读取完毕后都会删除)<br>缺点：耗时长，消息延迟高</p>
<p><strong>2. 推模式</strong></p>
<ul>
<li>也称为写扩散</li>
</ul>
<p>发送消息的用户会直接将发送的消息推送到关注他的用户的收件箱内并按时间戳排序，收消息的人则直接读取收件箱内的消息<br><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.15-58-54.png"></p>
<p>优点：消息延迟低<br>缺点：占用空间大</p>
<p><strong>3. 推拉结合</strong> </p>
<ul>
<li>也称为读写混合，兼具推和拉两种模式的优点</li>
</ul>
<p>将发消息的人分为两种：</p>
<ol>
<li>大V,粉丝数量多</li>
<li>普通人：粉丝数量少</li>
</ol>
<p>收消息的人也分为两种：</p>
<ol>
<li>普通粉丝（查看消息频率一般）</li>
<li>狂热粉丝（查看消息频率高）</li>
</ol>
<ul>
<li>当普通人发送消息时，由于粉丝少可以采取写模式，将发送的消息直接推送到少数粉丝的收件箱。</li>
<li>当大v发送消息时，收消息的人多采取读模式，将消息发送到发件箱，收消息的人需要先从大V发件箱拉取消息到自己的收件箱再进行查看</li>
<li>由于狂热粉丝查看消息频率高，所以当大v发送消息时直接将消息写到狂热粉丝的收件箱</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-08-51.png"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-10-39.png"></p>
<h2 id="基于推模式实现关注推送消息功能"><a href="#基于推模式实现关注推送消息功能" class="headerlink" title="基于推模式实现关注推送消息功能"></a>基于推模式实现关注推送消息功能</h2><ul>
<li>修改新增点评的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</li>
<li>收件箱满足可以根据时间戳排序，必须使用redis的数据结构实现</li>
<li>查询收件箱数据时，可以实现分页查询</li>
</ul>
<p><strong>feed流的分页问题:</strong> feed流中的数据会不断更新，所以数据的角标也在变化，不能采取传统的分页模式</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-26-59.png"></p>
<p>当用户在t1发送了10条消息时按时间排序，进行分页读取从“消息10“到”消息6“，但是在t2时刻发布了新的消息11，按照时间排序，消息11将排在最后面，t3时刻进行分页读取第二页的内容时将会从消息6开始读取，造成消息重复读取</p>
<p><strong>feed流的滚动分页：</strong> </p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://7601.oss-cn-hangzhou.aliyuncs.com/noteImg/20221022.16-32-05.png"></p>
<p>第一次将分页读取的id指定为无穷大或当前时间戳，下一次查询lastid为上一次的最小值为消息6，当t2发布新内容后，将会从消息6开始分页避免了消息重复读取</p>
<p>list集合只能根据角标查询不支持滚动分页，所以这里使用redis的有序集合作为收件箱，利用有序集合的score进行查询</p>
<ul>
<li><strong>对原来的保存点评功能进行修改，并实现推送消息到粉丝redis有序集合收件箱</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;  </span><br><span class="line">    <span class="comment">// 获取登录用户  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    blog.setUserId(usrId);  </span><br><span class="line">    <span class="comment">// 保存探店博文  </span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);  </span><br><span class="line">    <span class="keyword">if</span> (!isSuccess)&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增点评失败&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//查询发送消息人的所以粉丝  </span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, usrId).list();  </span><br><span class="line">    <span class="comment">//推送blog的id给所有粉丝  </span></span><br><span class="line">    <span class="type">long</span> <span class="variable">timeMillis</span> <span class="operator">=</span> System.currentTimeMillis();  </span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;  </span><br><span class="line">        <span class="comment">//获取粉丝id  </span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();  </span><br><span class="line">        <span class="comment">//推送  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed:&quot;</span> + userId;  </span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key,blog.getId().toString(),timeMillis);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 返回id  </span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现关注推送页面的分页查询"><a href="#实现关注推送页面的分页查询" class="headerlink" title="实现关注推送页面的分页查询"></a>实现关注推送页面的分页查询</h2><p><strong>滚动查询的参数：</strong></p>
<ol>
<li>max:  上一次查询的最小时间戳（第一次查询时设为当时间戳）</li>
<li>min: 0（固定为0）</li>
<li>offset: 在上一次的结果中，与最小值一样的元素个数（第一次查询时设置为0）</li>
<li>count: 3（根据前端要求设置数量）</li>
</ol>
<ul>
<li>第一次分页查询的请求：<br>\<a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/of/follow?&amp;lastId=1666430380422">http://localhost:8080/api/blog/of/follow?&amp;lastId=1666430380422</a></li>
</ul>
<p>请求参数：</p>
<ol>
<li>lastId：上一次查询的最小时间戳</li>
<li>offset：偏移量</li>
</ol>
<p>返回值：</p>
<ol>
<li>List&lt;Blog&gt;：小于指定时间戳的点评集合</li>
<li>minTime：本次查询的推送的最小时间戳</li>
<li>offset：偏移量</li>
</ol>
<ul>
<li>定义返回的数据DTO</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;  </span><br><span class="line">    <span class="keyword">private</span> Long minTime;  </span><br><span class="line">    <span class="keyword">private</span> Integer offset;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>分页方法的实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">pageFollow</span><span class="params">(Long max, Integer offset)</span> &#123;  </span><br><span class="line">    <span class="comment">//查询当前用户的收件箱  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">usrId</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.FEED_KEY + usrId;  </span><br><span class="line">    <span class="comment">//查询收件箱 ZREVRANGEBYSCORE key Max Min LIMIT offset count    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTupleSet = stringRedisTemplate.opsForZSet()  </span></span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==typedTupleSet||typedTupleSet.isEmpty())&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//解析数据：blogId ，score(时间戳) , offset  </span></span><br><span class="line">    List&lt;Long&gt; idList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTupleSet.size());  </span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">OS</span> <span class="operator">=</span> <span class="number">1</span>;  </span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; stringTypedTuple : typedTupleSet) &#123;  </span><br><span class="line">        <span class="comment">//获取id  </span></span><br><span class="line">        <span class="type">String</span>  <span class="variable">id</span> <span class="operator">=</span> stringTypedTuple.getValue();  </span><br><span class="line">        idList.add(Long.valueOf(id));  </span><br><span class="line">        <span class="comment">//获取时间戳  </span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> stringTypedTuple.getScore().longValue();  </span><br><span class="line">        <span class="keyword">if</span> (minTime==time)&#123;  </span><br><span class="line">            OS++;  </span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">            minTime = time;  </span><br><span class="line">            OS = <span class="number">1</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//根据id查询blog  </span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, idList);  </span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, idList)  </span><br><span class="line">            .last(<span class="string">&quot;ORDER BY FIELD (id,&quot;</span> + idStr + <span class="string">&quot;) &quot;</span>).list();  </span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;  </span><br><span class="line">        <span class="comment">//查询有关用户id,并封装数据  </span></span><br><span class="line">        userQuery(blog);  </span><br><span class="line">        <span class="comment">//查询是否被点赞  </span></span><br><span class="line">        BlogIsLiked(blog);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//封装数据返回  </span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">scrollResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();  </span><br><span class="line">    scrollResult.setList(blogs);  </span><br><span class="line">    scrollResult.setOffset(OS);  </span><br><span class="line">    scrollResult.setMinTime(minTime);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(scrollResult);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h1 id="附近商户"><a href="#附近商户" class="headerlink" title="附近商户"></a>附近商户</h1><h2 id="GEO数据结构"><a href="#GEO数据结构" class="headerlink" title="GEO数据结构"></a>GEO数据结构</h2><p>Geolocation，表示地理坐标。redis在3.2版本中加入了对GEO的支持，允许储存地理坐标信息，可以根据经纬度来检索数据</p>
<p><strong>常见命令：</strong></p>
<ul>
<li>GEOADD：添加一个地理空间信息(经度，纬度，值)</li>
<li>GEODIST：计算指定的两个点之间的距离并返回</li>
<li>GEOHASH：将指定member的坐标转为hash字符串形式并返回</li>
<li>GEOPOS：返回指定member的坐标</li>
<li>GEORADIUS：指定圆心半径，找到该园内包含的所有member，并安装与圆心之间的距离排序后返回，6.2后已废弃</li>
<li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形，6.2新功能</li>
<li>GEOSEARCHSTORE：与GEOSEARCH功能一致，但可以将结果储存到一个指定的key，6.2新功能</li>
</ul>
<h2 id="附近商户搜索"><a href="#附近商户搜索" class="headerlink" title="附近商户搜索"></a>附近商户搜索</h2><h3 id="导入店铺GEO数据"><a href="#导入店铺GEO数据" class="headerlink" title="导入店铺GEO数据"></a>导入店铺GEO数据</h3><ul>
<li>将原有店铺数据导入到redisGEO中，保存店铺typeID，经纬度<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//添加数据  </span></span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="comment">//查询店铺信息  </span></span><br><span class="line">        List&lt;Shop&gt; shopList = shopService.list();  </span><br><span class="line">        <span class="comment">//将typeId一致的店铺分为一个组  </span></span><br><span class="line">        Map&lt;Long, List&lt;Shop&gt;&gt; collect = shopList.stream().collect(Collectors.groupingBy(shop -&gt; &#123;  </span><br><span class="line">            <span class="keyword">return</span> shop.getTypeId();  </span><br><span class="line">        &#125;));  </span><br><span class="line">        <span class="comment">//分批写入redis  </span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; longListEntry : collect.entrySet()) &#123;  </span><br><span class="line">            <span class="comment">//获取类型id  </span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">type</span> <span class="operator">=</span> longListEntry.getKey();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;shop:geo:&quot;</span> + type;  </span><br><span class="line">            <span class="comment">//获取同类型的店铺集合  </span></span><br><span class="line">            List&lt;Shop&gt; value = longListEntry.getValue();  </span><br><span class="line">            <span class="comment">//直接利用循环将店铺id 经纬度存入redis  </span></span><br><span class="line"><span class="comment">//            for (Shop shop : value) &#123;  </span></span><br><span class="line"><span class="comment">//                stringRedisTemplate.opsForGeo()  </span></span><br><span class="line"><span class="comment">//                        .add(key,  </span></span><br><span class="line"><span class="comment">//                             new Point(shop.getX(),shop.getY()), //坐标点  </span></span><br><span class="line"><span class="comment">//                             shop.getId().toString());//店铺id  </span></span><br><span class="line"><span class="comment">//            &#125;  </span></span><br><span class="line">            <span class="comment">//先存入List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;集合中再统一写入redis，可以提高速度  </span></span><br><span class="line">            List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());  </span><br><span class="line">            <span class="keyword">for</span> (Shop shop : value) &#123;  </span><br><span class="line">                locations.add(  </span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(  </span><br><span class="line">                                shop.getId().toString(),  </span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(),  </span><br><span class="line">                                        shop.getY())));  </span><br><span class="line">                stringRedisTemplate.opsForGeo().add(key, locations);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="进行修改"><a href="#进行修改" class="headerlink" title="进行修改"></a>进行修改</h3><ul>
<li><strong>注意：</strong><blockquote>
<p>由于本项目使用的springboot不是最新版本，所以spring-boot-starter-data-redis内的spring-data-redis版本无法使用GEOSEARCH命令。这里将spring-boot-starter-data-redis内的spring-data-redis去除，再手动添加最新的依赖</p>
</blockquote>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--            去除旧版本的spring-data-redis和lettuce--&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>                    </span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>                   </span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span>            </span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!-- 添加最新的spring-data-redis --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加最新的lettuce --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>controller改造：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(  </span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,  </span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,  </span></span><br><span class="line"><span class="params">        //坐标参数不一定会有，所以这里设置required = <span class="literal">false</span>  </span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;,required = false)</span> Double x,  </span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;,required = false)</span> Double y  </span></span><br><span class="line"><span class="params">)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span>  shopService.queryShopById(typeId,current,x,y);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>Servercie方法实现：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;  </span><br><span class="line">    <span class="comment">//先判断是否需要按坐标进行查询  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == x || <span class="literal">null</span> == y) &#123;  </span><br><span class="line">        <span class="comment">//不需要坐标查询，直接从数据库查询  </span></span><br><span class="line">        <span class="comment">// 根据类型分页查询  </span></span><br><span class="line">        Page&lt;Shop&gt; page = query()  </span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)  </span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));  </span><br><span class="line">        <span class="comment">// 返回数据  </span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//计算分页参数  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;  </span><br><span class="line">    <span class="comment">//查询redis按照距离排序，分页。 返回数据：shopID 距离distance  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;shop:geo:&quot;</span>+typeId;  </span><br><span class="line">  </span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; geoResults = stringRedisTemplate.opsForGeo().search(  </span><br><span class="line">            key,  </span><br><span class="line">            GeoReference.fromCoordinate(x, y),  </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),  </span><br><span class="line">            <span class="comment">//设置带上距离单位  </span></span><br><span class="line">            RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance()  </span><br><span class="line">                    <span class="comment">//设置查询的个数，每次都从0开始查询  </span></span><br><span class="line">                    .limit(end)  </span><br><span class="line">    );  </span><br><span class="line">    <span class="comment">//解析id查询shop  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==geoResults)&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; geoResultsContent = geoResults.getContent();  </span><br><span class="line"><span class="comment">//截取数据，从form到end结束  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (geoResultsContent.size()&lt;=from)&#123;  </span><br><span class="line">        <span class="comment">//查询到了数据的最后一页，后面没有数据了  </span></span><br><span class="line">        <span class="keyword">return</span>  Result.ok(Collections.emptyList());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//创建list集合收集id  </span></span><br><span class="line">    List&lt;Long&gt; idList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(geoResultsContent.size());  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//保存距离的map集合  </span></span><br><span class="line">    Map&lt;String,Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">    geoResultsContent.stream().skip(from).forEach(  </span><br><span class="line">            result -&gt;&#123;  </span><br><span class="line">                <span class="comment">//获取店铺id  </span></span><br><span class="line">                <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> result.getContent().getName();  </span><br><span class="line">                idList.add(Long.valueOf(idStr));  </span><br><span class="line">                <span class="comment">//获取距离  </span></span><br><span class="line">                <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();  </span><br><span class="line">                distanceMap.put(idStr,distance);  </span><br><span class="line">            &#125;  </span><br><span class="line">    );  </span><br><span class="line">    <span class="comment">//根据id查询shop  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ids</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, idList);  </span><br><span class="line">    List&lt;Shop&gt; shopList = query().  </span><br><span class="line">            in(<span class="string">&quot;id&quot;</span>, idList).  </span><br><span class="line">            last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + ids + <span class="string">&quot;)&quot;</span>).  </span><br><span class="line">            list();  </span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shopList) &#123;  </span><br><span class="line">        shop.setDistance(  </span><br><span class="line">                distanceMap.get(shop.getId().toString()).  </span><br><span class="line">                getValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(shopList);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h1 id="用户签到"><a href="#用户签到" class="headerlink" title="用户签到"></a>用户签到</h1><h2 id="redis中bitmap的用法"><a href="#redis中bitmap的用法" class="headerlink" title="redis中bitmap的用法"></a>redis中bitmap的用法</h2><ul>
<li>基本原理<blockquote>
<p>BitMap 的基本原理就是用一个 bit 来标记某个元素对应的 Value，而 Key 即是该元素。由于采用一 个bit 来存储一个数据，因此可以大大的节省空间。</p>
</blockquote>
</li>
</ul>
<p><strong>redis</strong>利用string类型数据结构实现bitmap，因此最大上限是512M</p>
<p><strong>redis中bitmap的操作命令有：</strong></p>
<ul>
<li>SETBIT：向指定位置存入一个0或1</li>
<li>GETBIT：获取指定位置的bit值</li>
<li>BITCOUNT：统计bitmap中值为1的bit位的数量</li>
<li>BITFIELD：操作（查询，修改，自增）bitmap中bit数组中的指定位置的值</li>
<li>BITFIELD_OR：获取bitmap中bit数组，并以10进制形式返回</li>
<li>BITOP：将多个bitmap的结果做位运算(与，或，异或)</li>
<li>BITPOS：查找bit数组中指定范围内第一个0或1出现的位置</li>
</ul>
<h2 id="签到功能"><a href="#签到功能" class="headerlink" title="签到功能"></a>签到功能</h2><ul>
<li>将当前用户当天签到信息保存到redis中</li>
<li>bitmap底层是基于string数据结构，redis对bitmap的操作也都封装在字符串相关操作中</li>
</ul>
<p>实现签到功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="comment">//获取当前用户  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//获取日期  </span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> LocalDateTime.now();  </span><br><span class="line">    <span class="comment">//拼接key  </span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">keySuffix</span> <span class="operator">=</span> dateTime.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMM&quot;</span>));  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + id + keySuffix;  </span><br><span class="line">    <span class="comment">//获取今天是本月的第几天  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> dateTime.getDayOfMonth();  </span><br><span class="line">    <span class="comment">//写入redis  </span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key,day-<span class="number">1</span>,<span class="literal">true</span>);  </span><br><span class="line">    <span class="keyword">return</span> Result.ok();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="签到统计"><a href="#签到统计" class="headerlink" title="签到统计"></a>签到统计</h2><ul>
<li><p>统计连续签到的次数</p>
</li>
<li><p>通过将bitmap中的数据与1进行与运算来得到最后一个bit位</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="comment">//获取当前用户  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//获取日期  </span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> LocalDateTime.now();  </span><br><span class="line">    <span class="comment">//拼接key  </span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">keySuffix</span> <span class="operator">=</span> dateTime.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMM&quot;</span>));  </span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.USER_SIGN_KEY + id + keySuffix;  </span><br><span class="line">    <span class="comment">//获取今天是本月的第几天  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> dateTime.getDayOfMonth();  </span><br><span class="line">    <span class="comment">//获取本月截至今天所有的签到记录,返回的是一个10进制数字  </span></span><br><span class="line">    List&lt;Long&gt; bitField = stringRedisTemplate.opsForValue().bitField(  </span><br><span class="line">            key,  </span><br><span class="line">            BitFieldSubCommands.  </span><br><span class="line">                    create().                get(BitFieldSubCommands.BitFieldType.unsigned(day)).valueAt(<span class="number">0</span>)  </span><br><span class="line">    );  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==bitField||bitField.isEmpty())&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//由于确定bitField内只有一个值所以直接取出  </span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">aLong</span> <span class="operator">=</span> bitField.get(<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>==aLong||<span class="number">0</span>==aLong)&#123;  </span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//遍历循环  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//计数器  </span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;  </span><br><span class="line">        <span class="comment">//与1做与运算得到数字的最后一个bit位,并判断这个bit位是否位0  </span></span><br><span class="line">        <span class="keyword">if</span> ((aLong &amp; <span class="number">1</span>)==<span class="number">0</span>)&#123;  </span><br><span class="line">         <span class="comment">//未签到,结束  </span></span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">           count++;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//将数字右移1位，抛弃最后一个bit位，继续下一个bit位  </span></span><br><span class="line">        aLong &gt;&gt;&gt;= <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span>  Result.ok(count);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="UV统计"><a href="#UV统计" class="headerlink" title="UV统计"></a>UV统计</h1><ul>
<li>UV（Unique Vistor）<strong>独立访客量</strong>，指通过互联网访问，浏览这个网页的自然人。1天内统一个用户多次访问该网站，只记录一次</li>
<li>PV （Page View）<strong>页面访问量或点击量</strong>，用户每访问网站的一个页面，记录1次PV，多次打开页面则记录多次PV</li>
</ul>
<h1 id="Redis-HyperLogLog"><a href="#Redis-HyperLogLog" class="headerlink" title="Redis HyperLogLog"></a>Redis HyperLogLog</h1><p>Redis 在 2.8.9 版本添加了 HyperLogLog 结构。</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定 的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<hr>
<h2 id="什么是基数"><a href="#什么是基数" class="headerlink" title="什么是基数?"></a>什么是基数?</h2><p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<hr>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>以下实例演示了 HyperLogLog 的工作过程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey <span class="string">&quot;redis&quot;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey <span class="string">&quot;mysql&quot;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; PFCOUNT runoobkey</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>

<h2 id="Redis-HyperLogLog-命令"><a href="#Redis-HyperLogLog-命令" class="headerlink" title="Redis HyperLogLog 命令"></a>Redis HyperLogLog 命令</h2><p>下表列出了 redis HyperLogLog 的基本命令：</p>
<table>
<thead>
<tr>
<th></th>
<th>命令及描述</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/hyperloglog-pfadd.html">PFADD key element [element …]</a>添加指定元素到 HyperLogLog 中。</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/hyperloglog-pfcount.html">PFCOUNT key [key …]</a> 返回给定 HyperLogLog 的基数估算值</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/hyperloglog-pfmerge.html">PFMERGE destkey sourcekey [sourcekey …]</a>将多个 HyperLogLog 合并为一个 HyperLogLog</td>
<td></td>
</tr>
</tbody></table>
<h1 id="项目完整代码"><a href="#项目完整代码" class="headerlink" title="项目完整代码"></a>项目完整代码</h1><p><a target="_blank" rel="noopener" href="https://gitee.com/seven601/itheima-hmdp">itheima-hmdp: 学习redis的黑马点评案例 (gitee.com)</a></p>


<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>










      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本站由 <a href="/">@anonymity</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.17.2';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.17.2';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://fastly.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@6/swiper-bundle.min.css","js":"https://unpkg.com/swiper@6/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://fastly.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://fastly.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://fastly.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti/umd/heti.min.css","js":"https://unpkg.com/heti/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->



<!-- inject -->


  </div>
</body>
</html>
